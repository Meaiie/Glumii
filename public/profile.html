<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î */
        /* ‡∏ã‡πà‡∏≠‡∏ô edit-mode ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å */
        .profile-grid.display-mode .form-group {
            display: none;
        }
        /* ‡πÅ‡∏™‡∏î‡∏á display-mode ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å */
        .profile-grid.display-mode span {
            display: block;
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô display-mode ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .profile-grid.edit-mode span {
            display: none;
        }
        /* ‡πÅ‡∏™‡∏î‡∏á edit-mode ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .profile-grid.edit-mode .form-group {
            display: block; /* ‡∏´‡∏£‡∏∑‡∏≠ 'flex' / 'grid' ‡∏ï‡∏≤‡∏° layout ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        }

        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ conditional inputs (‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß, ‡∏¢‡∏≤) */
        .conditional-input {
            display: none;
        }
        .conditional-input.show {
            display: block; /* ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏î layout */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span>‚ù§Ô∏è ‡πÅ‡∏≠‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span>
            <div class="user-info">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="liffDisplayName">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà</span> <span>üë©‚Äçü¶∞</span>
            </div>
        </div>

        <div class="nav-tabs">
            <a href="#" class="nav-tab active" id="profileTab"> <i class="fas fa-user-alt"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </a>
            <a href="#" class="nav-tab" id="foodRecordsTab"> <i class="fas fa-utensils"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </a>
            <a href="#" class="nav-tab" id="sugarRecordsTab"> <i class="fas fa-tint"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
            </a>
        </div>

        <div class="profile-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>

            <div class="profile-section" id="personalProfileSection">
                <div class="section-header">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <button class="edit-btn" id="editProfileBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <div class="button-group edit-mode-btns" style="display: none;">
                        <button class="cancel-btn" id="cancelEditBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button class="save-btn" id="saveProfileBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </div>

                <form id="profileForm">
                    <div class="profile-grid display-mode">
                        <div class="profile-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <span id="displayFullName"></span>
                            <div class="form-group">
                                <input type="text" id="editFullName" name="full_name" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                            <span id="displayNickname"></span>
                            <div class="form-group">
                                <input type="text" id="editNickname" name="nickname" required>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label>
                            <span id="displayHospitalId"></span>
                            <div class="form-group">
                                <input type="text" id="editHospitalId" name="hospital_id" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                            <span id="displayNationalId"></span>
                            <div class="form-group">
                                <input type="text" id="editNationalId" name="national_id" pattern="[0-9]{13}" maxlength="13" required>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                            <span id="displayBirthDate"></span>
                            <div class="form-group">
                                <input type="date" id="editBirthDate" name="birth_date" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <span id="displayAge"></span>
                            <div class="form-group">
                                <input type="number" id="editAge" name="age" min="15" max="60">
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                            <span id="displayHeight"></span>
                            <div class="form-group">
                                <input type="number" id="editHeight" name="height" min="100" max="200" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏Å‡∏Å.)</label>
                            <span id="displayPrePregnancyWeight"></span>
                            <div class="form-group">
                                <input type="number" id="editPrePregnancyWeight" name="pre_pregnancy_weight" min="30" max="150" step="0.1" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.)</label>
                            <span id="displayWeight"></span>
                            <div class="form-group">
                                <input type="number" id="editWeight" name="weight" min="30" max="150" step="0.1" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>BMI</label>
                            <span id="displayBMI"></span>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                            <span id="displayWeightGain"></span>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <span id="displayComorbidities"></span>
                            <div class="form-group">
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="editComorbiditiesNo" name="comorbidities_radio" value="‡πÑ‡∏°‡πà‡∏°‡∏µ">
                                        <label for="editComorbiditiesNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="editComorbiditiesYes" name="comorbidities_radio" value="‡∏°‡∏µ">
                                        <label for="editComorbiditiesYes">‡∏°‡∏µ</label>
                                    </div>
                                </div>
                                <div class="conditional-input" id="editComorbiditiesDetail">
                                    <input type="text" id="editComorbidities" name="comorbidities_input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß">
                                </div>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                            <span id="displayPrePregnancyMedications"></span>
                            <div class="form-group">
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="editPrePregnancyMedicationsNo" name="pre_pregnancy_medications_radio" value="‡πÑ‡∏°‡πà‡∏°‡∏µ">
                                        <label for="editPrePregnancyMedicationsNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="editPrePregnancyMedicationsYes" name="pre_pregnancy_medications_radio" value="‡∏°‡∏µ">
                                        <label for="editPrePregnancyMedicationsYes">‡∏°‡∏µ</label>
                                    </div>
                                </div>
                                <div class="conditional-input" id="editPrePregnancyMedicationsDetail">
                                    <textarea id="editPrePregnancyMedications" name="pre_pregnancy_medications_input" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                            <span id="displayFetusCount"></span>
                            <div class="form-group">
                                <select id="editFetusCount" name="fetus_count" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å</option>
                                    <option value="1">1 ‡∏Ñ‡∏ô</option>
                                    <option value="2">2 ‡∏Ñ‡∏ô</option>
                                    <option value="3">3 ‡∏Ñ‡∏ô</option>
                                    <option value="4">4 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤</option>
                                </select>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î</label>
                            <span id="displayDueDate"></span>
                            <div class="form-group">
                                <input type="date" id="editDueDate" name="due_date" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</label>
                            <span id="displayGestationalWeek"></span>
                        </div>
                        <div class="profile-item">
                            <label>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏Å‡∏¥‡πÇ‡∏•‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ/‡∏ß‡∏±‡∏ô)</label>
                            <span id="displayCalorieRequired"></span>
                        </div>
                        <div class="profile-item">
                            <label>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏≤‡∏£‡πå‡∏ö/‡∏ß‡∏±‡∏ô)</label>
                            <span id="displayCarbUnitRequired"></span>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏£‡πå‡∏ö (‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏¢‡πá‡∏ô)</label>
                            <span id="displayCarbRatio"></span>
                            <div class="form-group">
                                <div class="carb-ratio-group">
                                    <div><label for="editCarbRatioBreakfast">‡πÄ‡∏ä‡πâ‡∏≤:</label> <input type="number" id="editCarbRatioBreakfast" name="carb_ratio_breakfast" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30 %" required></div>
                                    <div><label for="editCarbRatioLunch">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô:</label> <input type="number" id="editCarbRatioLunch" name="carb_ratio_lunch" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 40 %" required></div>
                                    <div><label for="editCarbRatioDinner">‡πÄ‡∏¢‡πá‡∏ô:</label> <input type="number" id="editCarbRatioDinner" name="carb_ratio_dinner" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30 %" required></div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (PBS Date)</label>
                            <span id="displayPbsDate"></span>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <div class="checkbox-item"><input type="checkbox" id="editMonday" class="sugar-check" value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå"><label for="editMonday">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editTuesday" class="sugar-check" value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£"><label for="editTuesday">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editWednesday" class="sugar-check" value="‡∏û‡∏∏‡∏ò"><label for="editWednesday">‡∏û‡∏∏‡∏ò</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editThursday" class="sugar-check" value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ"><label for="editThursday">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editFriday" class="sugar-check" value="‡∏®‡∏∏‡∏Å‡∏£‡πå"><label for="editFriday">‡∏®‡∏∏‡∏Å‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editSaturday" class="sugar-check" value="‡πÄ‡∏™‡∏≤‡∏£‡πå"><label for="editSaturday">‡πÄ‡∏™‡∏≤‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editSunday" class="sugar-check" value="‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"><label for="editSunday">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label></div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label>
                            <span id="displayRegistrationDate"></span>
                        </div>

                    </div>
                </form>
            </div>

            <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
            <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let isLiffReady = false;
        let liffUserId = null;
        let currentProfileData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤

        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007493917-XdpdZalP" }); // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

                    const profile = await liff.getProfile();
                    liffUserId = profile.userId;
                    document.getElementById('liffDisplayName').innerText = profile.displayName || '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà';

                    await getPatientProfileData(liffUserId);
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
            }
        }

        async function getPatientProfileData(userId) {
            console.log('Fetching user profile for userId:', userId);
            document.getElementById('liffStatus').innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...';

            try {
                const url = '/.netlify/functions/apps-script-proxy';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'getProfile', userId: userId })
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Profile data from Netlify Function:', result);

                if (result.status === 'success' && result.profileData) {
                    currentProfileData = result.profileData; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ
                    displayProfileData(currentProfileData);
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                } else {
                    console.error('Error fetching profile data:', result.message || 'No profile data found.');
                    document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
                    setTimeout(() => {
                        window.location.href = `index.html`; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å liff.openWindow ‡πÄ‡∏õ‡πá‡∏ô window.location.href
                    }, 3000);
                }

            } catch (error) {
                console.error('Error getting user profile via Netlify Function:', error);
                document.getElementById('liffStatus').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
                setTimeout(() => {
                    window.location.href = `index.html`; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å liff.openWindow ‡πÄ‡∏õ‡πá‡∏ô window.location.href
                }, 5000);
            }
        }

        function displayProfileData(data) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î display
            document.getElementById('displayFullName').innerText = data.full_name || 'N/A';
            document.getElementById('displayNickname').innerText = data.nickname || 'N/A';
            document.getElementById('displayHospitalId').innerText = data.hospital_id || 'N/A';
            document.getElementById('displayNationalId').innerText = data.national_id || 'N/A';
            document.getElementById('displayBirthDate').innerText = data.birth_date ? new Date(data.birth_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            document.getElementById('displayAge').innerText = data.age ? `${data.age} ‡∏õ‡∏µ` : 'N/A';
            document.getElementById('displayHeight').innerText = data.height ? `${data.height} ‡∏ã‡∏°.` : 'N/A';
            document.getElementById('displayPrePregnancyWeight').innerText = data.pre_pregnancy_weight ? `${data.pre_pregnancy_weight} ‡∏Å‡∏Å.` : 'N/A';
            document.getElementById('displayWeight').innerText = data.weight ? `${data.weight} ‡∏Å‡∏Å.` : 'N/A';
            document.getElementById('displayBMI').innerText = data.bmi || 'N/A';
            document.getElementById('displayWeightGain').innerText = data.weight_gain || 'N/A';

            document.getElementById('displayComorbidities').innerText = data.comorbidities || 'N/A';
            document.getElementById('displayPrePregnancyMedications').innerText = data.pre_pregnancy_medications || 'N/A';

            document.getElementById('displayFetusCount').innerText = data.fetus_count ? `${data.fetus_count} ‡∏Ñ‡∏ô` : 'N/A';
            document.getElementById('displayDueDate').innerText = data.due_date ? new Date(data.due_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            document.getElementById('displayGestationalWeek').innerText = data.gestational_week ? `${data.gestational_week} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå` : 'N/A';
            document.getElementById('displayCalorieRequired').innerText = data.calorie_required ? `${data.calorie_required} kcal` : 'N/A';
            document.getElementById('displayCarbUnitRequired').innerText = data.carb_unit_required ? `${data.carb_unit_required} ‡∏´‡∏ô‡πà‡∏ß‡∏¢` : 'N/A';



            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
            if (data.birth_date) {
                const birthDate = new Date(data.birth_date);
                document.getElementById('editBirthDate').value = birthDate.toISOString().split('T')[0];
            } else {
                document.getElementById('editBirthDate').value = '';
                }

            // Carb Ratio
            const carbRatioText = (data.carb_ratio && typeof data.carb_ratio === 'object')
                                        ? `‡πÄ‡∏ä‡πâ‡∏≤: ${data.carb_ratio.breakfast || 0}% / ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô: ${data.carb_ratio.lunch || 0}% / ‡πÄ‡∏¢‡πá‡∏ô: ${data.carb_ratio.dinner || 0}%`
                                        : 'N/A';
            document.getElementById('displayCarbRatio').innerText = carbRatioText;

            // PBS Date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)
            const displayPbsDateElement = document.getElementById('displayPbsDate');
            if (displayPbsDateElement) {
                if (data.pbs_date && Array.isArray(data.pbs_date) && data.pbs_date.length > 0) {
                    displayPbsDateElement.innerText = data.pbs_date.join(', ');
                } else {
                    displayPbsDateElement.innerText = '‡πÑ‡∏°‡πà‡∏°‡∏µ'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array
                }
            }

            document.getElementById('displayRegistrationDate').innerText = data.registration_date ? new Date(data.registration_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';

            // ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            setDisplayMode();
        }

        function populateEditForm(data) {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('editFullName').value = data.full_name || '';
            document.getElementById('editNickname').value = data.nickname || '';
            document.getElementById('editHospitalId').value = data.hospital_id || '';
            document.getElementById('editNationalId').value = data.national_id || '';
            document.getElementById('editBirthDate').value = data.birth_date || '';
            document.getElementById('editAge').value = data.age || '';
            document.getElementById('editHeight').value = data.height || '';
            document.getElementById('editPrePregnancyWeight').value = data.pre_pregnancy_weight || '';
            document.getElementById('editWeight').value = data.weight || '';
            document.getElementById('editFetusCount').value = data.fetus_count || '';
            document.getElementById('editDueDate').value = data.due_date || '';

            // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
            const editComorbiditiesNo = document.getElementById('editComorbiditiesNo');
            const editComorbiditiesYes = document.getElementById('editComorbiditiesYes');
            const editComorbiditiesDetail = document.getElementById('editComorbiditiesDetail');
            const editComorbiditiesInput = document.getElementById('editComorbidities');

            if (data.comorbidities === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                editComorbiditiesNo.checked = true;
                editComorbiditiesDetail.classList.remove('show');
                editComorbiditiesInput.value = '';
                editComorbiditiesInput.required = false;
            } else if (data.comorbidities && data.comorbidities !== 'N/A' && data.comorbidities !== '') {
                editComorbiditiesYes.checked = true;
                editComorbiditiesDetail.classList.add('show');
                editComorbiditiesInput.value = data.comorbidities;
                editComorbiditiesInput.required = true;
            } else {
                editComorbiditiesNo.checked = true; // Default to '‡πÑ‡∏°‡πà‡∏°‡∏µ' if no data or invalid
                editComorbiditiesDetail.classList.remove('show');
                editComorbiditiesInput.value = '';
                editComorbiditiesInput.required = false;
            }

            // ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå
            const editMedicationsNo = document.getElementById('editPrePregnancyMedicationsNo');
            const editMedicationsYes = document.getElementById('editPrePregnancyMedicationsYes');
            const editMedicationsDetail = document.getElementById('editPrePregnancyMedicationsDetail');
            const editMedicationsInput = document.getElementById('editPrePregnancyMedications');

            if (data.pre_pregnancy_medications === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                editMedicationsNo.checked = true;
                editMedicationsDetail.classList.remove('show');
                editMedicationsInput.value = '';
                editMedicationsInput.required = false;
            } else if (data.pre_pregnancy_medications && data.pre_pregnancy_medications !== 'N/A' && data.pre_pregnancy_medications !== '') {
                editMedicationsYes.checked = true;
                editMedicationsDetail.classList.add('show');
                editMedicationsInput.value = data.pre_pregnancy_medications;
                editMedicationsInput.required = true;
            } else {
                editMedicationsNo.checked = true; // Default to '‡πÑ‡∏°‡πà‡∏°‡∏µ' if no data or invalid
                editMedicationsDetail.classList.remove('show');
                editMedicationsInput.value = '';
                editMedicationsInput.required = false;
            }

            // Carb Ratio
            if (data.carb_ratio && typeof data.carb_ratio === 'object') {
                document.getElementById('editCarbRatioBreakfast').value = data.carb_ratio.breakfast || '';
                document.getElementById('editCarbRatioLunch').value = data.carb_ratio.lunch || '';
                document.getElementById('editCarbRatioDinner').value = data.carb_ratio.dinner || '';
            } else {
                document.getElementById('editCarbRatioBreakfast').value = '';
                document.getElementById('editCarbRatioLunch').value = '';
                document.getElementById('editCarbRatioDinner').value = '';
            }

            // PBS Date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)
            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.checked = false; // clear all first
                checkbox.disabled = false; // ensure all are enabled before setting
            });
            if (data.pbs_date && Array.isArray(data.pbs_date)) {
                data.pbs_date.forEach(day => {
                    const checkbox = document.querySelector(`.sugar-check[value="${day}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            checkSugarCheckboxes(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        }

        // ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function setDisplayMode() {
            document.querySelector('.profile-grid').classList.remove('edit-mode');
            document.querySelector('.profile-grid').classList.add('display-mode');
            document.getElementById('editProfileBtn').style.display = 'block';
            document.querySelector('.edit-mode-btns').style.display = 'none';

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ input fields ‡πÄ‡∏õ‡πá‡∏ô readonly ‡πÅ‡∏•‡∏∞ disabled ‡πÉ‡∏ô display mode
            const formInputs = document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea');
            formInputs.forEach(input => {
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('disabled', 'disabled');
            });
        }

        // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function setEditMode() {
            document.querySelector('.profile-grid').classList.add('edit-mode');
            document.querySelector('.profile-grid').classList.remove('display-mode');
            document.getElementById('editProfileBtn').style.display = 'none';
            document.querySelector('.edit-mode-btns').style.display = 'flex';

            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ input fields ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            const formInputs = document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea');
            formInputs.forEach(input => {
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
            });
            
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            populateEditForm(currentProfileData);
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô checkbox ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function checkSugarCheckboxes() {
            const checked = document.querySelectorAll('.sugar-check:checked');
            const allCheckboxes = document.querySelectorAll('.sugar-check');

            if (checked.length >= 3) {
                allCheckboxes.forEach(cb => {
                    if (!cb.checked) {
                        cb.disabled = true;
                    }
                });
            } else {
                allCheckboxes.forEach(cb => cb.disabled = false);
            }
        }

        async function handleSaveProfile(event) {
            event.preventDefault(); // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ form submit ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥

            if (!isLiffReady || !liffUserId) {
                console.warn('LIFF not ready or userId not available for saving profile.');
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (HTML5 validation)
            const form = document.getElementById('profileForm');
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ validate ‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á enable ‡∏Å‡πà‡∏≠‡∏ô
            form.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('disabled'));

            if (!form.checkValidity()) {
                form.reportValidity(); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏Ç‡∏≠‡∏á input ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                document.getElementById('errorMessage').style.display = 'block';
                // Re-disable inputs in display mode after validation fails
                setTimeout(() => {
                    if (document.getElementById('editProfileBtn').style.display === 'block') { // If still in display mode
                        form.querySelectorAll('input, select, textarea').forEach(el => el.setAttribute('disabled', 'disabled'));
                    }
                }, 100);
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            const formData = new FormData(form);
            const pbsDates = Array.from(document.querySelectorAll('.sugar-check:checked')).map(cb => cb.value);

            const data = {
                action: 'updateProfile', // Action for Google Apps Script
                userId: liffUserId,
                full_name: formData.get('full_name'),
                nickname: formData.get('nickname'),
                hospital_id: formData.get('hospital_id'),
                national_id: formData.get('national_id'),
                birth_date: formData.get('birth_date'),
                age: formData.get('age') ? parseInt(formData.get('age')) : null,
                height: formData.get('height') ? parseFloat(formData.get('height')) : null,
                pre_pregnancy_weight: formData.get('pre_pregnancy_weight') ? parseFloat(formData.get('pre_pregnancy_weight')) : null,
                weight: formData.get('weight') ? parseFloat(formData.get('weight')) : null,
                comorbidities: formData.get('comorbidities_radio') === '‡∏°‡∏µ' ? formData.get('comorbidities_input') : '‡πÑ‡∏°‡πà‡∏°‡∏µ',
                pre_pregnancy_medications: formData.get('pre_pregnancy_medications_radio') === '‡∏°‡∏µ' ? formData.get('pre_pregnancy_medications_input') : '‡πÑ‡∏°‡πà‡∏°‡∏µ',
                fetus_count: formData.get('fetus_count') ? parseInt(formData.get('fetus_count')) : null,
                due_date: formData.get('due_date'),
                carb_ratio: {
                    breakfast: formData.get('carb_ratio_breakfast') ? parseFloat(formData.get('carb_ratio_breakfast')) : null,
                    lunch: formData.get('carb_ratio_lunch') ? parseFloat(formData.get('carb_ratio_lunch')) : null,
                    dinner: formData.get('carb_ratio_dinner') ? parseFloat(formData.get('carb_ratio_dinner')) : null
                },
                pbs_date: pbsDates // Array of selected days
            };

            console.log('Data to be sent:', data);

            try {
                const url = '/.netlify/functions/apps-script-proxy';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Save profile result:', result);

                if (result.status === 'success') {
                    document.getElementById('successMessage').style.display = 'block';
                    currentProfileData = data; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                    displayProfileData(currentProfileData); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    setTimeout(() => document.getElementById('successMessage').style.display = 'none', 3000);
                } else {
                    document.getElementById('errorMessage').innerHTML = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || 'Unknown error'}`;
                    document.getElementById('errorMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                }

            } catch (error) {
                console.error('Error saving profile via Netlify Function:', error);
                document.getElementById('errorMessage').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`;
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();

            // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('editProfileBtn').addEventListener('click', setEditMode);

            // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            document.getElementById('cancelEditBtn').addEventListener('click', setDisplayMode);

            // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);

            // Radio button listeners for conditional inputs
            document.querySelectorAll('input[name="comorbidities_radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const detailDiv = document.getElementById('editComorbiditiesDetail');
                    const inputField = document.getElementById('editComorbidities');
                    if (this.value === '‡∏°‡∏µ') {
                        detailDiv.classList.add('show');
                        inputField.required = true;
                    } else {
                        detailDiv.classList.remove('show');
                        inputField.required = false;
                        inputField.value = ''; // Clear value if '‡πÑ‡∏°‡πà‡∏°‡∏µ' is selected
                    }
                });
            });

            document.querySelectorAll('input[name="pre_pregnancy_medications_radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const detailDiv = document.getElementById('editPrePregnancyMedicationsDetail');
                    const inputField = document.getElementById('editPrePregnancyMedications');
                    if (this.value === '‡∏°‡∏µ') {
                        detailDiv.classList.add('show');
                        inputField.required = true;
                    } else {
                        detailDiv.classList.remove('show');
                        inputField.required = false;
                        inputField.value = ''; // Clear value if '‡πÑ‡∏°‡πà‡∏°‡∏µ' is selected
                    }
                });
            });

            // Checkbox listener for PBS Date
            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.addEventListener('change', checkSugarCheckboxes);
            });

            // Tab handlers (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ window.location.href)
            document.getElementById('profileTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                if (window.location.pathname !== '/profile.html' && window.location.pathname !== '/') { // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á / ‡πÅ‡∏•‡∏∞ /profile.html
                    if (liff.isLoggedIn()) {
                        window.location.href = `${window.location.origin}/profile.html`;
                    } else {
                        console.warn('LIFF not logged in, cannot open profile page.');
                    }
                }
            });

            document.getElementById('foodRecordsTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                if (liff.isLoggedIn()) {
                    window.location.href = `${window.location.origin}/food_records.html`;
                } else {
                    console.warn('LIFF not logged in, cannot open food records page.');
                }
            });

            document.getElementById('sugarRecordsTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                if (liff.isLoggedIn()) {
                    window.location.href = `${window.location.origin}/sugar_records.html`;
                } else {
                    console.warn('LIFF not logged in, cannot open sugar records page.');
                }
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ setDisplayMode() ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            // setDisplayMode(); // ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å displayProfileData() ‡πÅ‡∏•‡πâ‡∏ß
        });
    </script>
</body>
</html>