<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î */
        /* ‡∏ã‡πà‡∏≠‡∏ô edit-mode ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å */
        .profile-grid.display-mode .form-group {
            display: none;
        }
        /* ‡πÅ‡∏™‡∏î‡∏á display-mode ‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å */
        .profile-grid.display-mode span {
            display: block;
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô display-mode ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .profile-grid.edit-mode span {
            display: none;
        }
        /* ‡πÅ‡∏™‡∏î‡∏á edit-mode ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .profile-grid.edit-mode .form-group {
            display: block; /* ‡∏´‡∏£‡∏∑‡∏≠ 'flex' / 'grid' ‡∏ï‡∏≤‡∏° layout ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        }

        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ conditional inputs (‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß, ‡∏¢‡∏≤) */
        .conditional-input {
            display: none;
        }
        .conditional-input.show {
            display: block; /* ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏î layout */
        }

        /* Custom Styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif; /* ‡πÉ‡∏ä‡πâ Font Inter */
            background-color: #f0f4f8; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÜ */
        }
        .container {
            max-width: 900px;
            background-color: white; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÉ‡∏´‡πâ container */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-lg */
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï */
            margin: 2rem auto; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
        }
        .header {
            background-color: #2c3e50; /* ‡∏™‡∏µ‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-top-left-radius: 0.75rem; /* rounded-t-xl */
            border-top-right-radius: 0.75rem; /* rounded-t-xl */
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
        }
        .user-info {
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .nav-tabs {
            background-color: #4a5568; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
            padding: 0.75rem;
            display: flex;
            justify-content: space-around;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }
        .nav-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.3s ease;
            cursor: pointer;
            color: #cbd5e0; /* text-gray-300 */
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .nav-tab.active {
            background-color: #1a202c; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ active */
            color: white;
        }
        .nav-tab:hover:not(.active) {
            background-color: #2d3748; /* ‡∏™‡∏µ hover */
            color: white;
        }
        .nav-tab i {
            margin-right: 0.5rem;
        }

        .profile-container {
            padding: 1.5rem;
        }
        .liff-status {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
        }
        .liff-connected {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .liff-disconnected {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2d3748; /* gray-800 */
        }
        .edit-btn, .save-btn, .cancel-btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .edit-btn {
            background-color: #3498db; /* primary blue */
            color: white;
        }
        .edit-btn:hover {
            background-color: #2980b9;
        }
        .save-btn {
            background-color: #27ae60; /* green */
            color: white;
        }
        .save-btn:hover {
            background-color: #229954;
        }
        .cancel-btn {
            background-color: #e74c3c; /* red */
            color: white;
            margin-right: 0.5rem;
        }
        .cancel-btn:hover {
            background-color: #c0392b;
        }
        .button-group {
            display: flex;
            gap: 0.5rem;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr 1fr;
            }
            .profile-item.full-width {
                grid-column: span 2;
            }
        }
        .profile-item {
            padding: 0.75rem;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.5rem;
            background-color: #f7fafc; /* gray-50 */
        }
        .profile-item label {
            display: block;
            font-weight: 600;
            color: #4a5568; /* gray-700 */
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .profile-item span {
            color: #2d3748; /* gray-800 */
            font-size: 1.1rem;
            min-height: 1.5rem; /* Ensure consistent height even if no data */
            display: block;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0; /* gray-300 */
            border-radius: 0.25rem;
            font-size: 1rem;
            color: #2d3748;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }
        .form-group input[readonly], .form-group input[disabled],
        .form-group select[readonly], .form-group select[disabled],
        .form-group textarea[readonly], .form-group textarea[disabled] {
            background-color: #e2e8f0; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.8;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
        }
        .radio-item input[type="radio"], .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        .radio-item label, .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 1rem;
            color: #2d3748;
        }

        .carb-ratio-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        @media (min-width: 768px) {
            .carb-ratio-group {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        .carb-ratio-group div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .carb-ratio-group label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: #4a5568;
        }
        .carb-ratio-group input {
            flex-grow: 1;
        }

        .loading, .success-message, .error-message {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .loading {
            background-color: #bfdbfe; /* blue-200 */
            color: #1e40af; /* blue-800 */
        }
        .success-message {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .error-message {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span>‚ù§Ô∏è ‡πÅ‡∏≠‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span>
            <div class="user-info">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="liffDisplayName">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà</span> <span>üë©‚Äçü¶∞</span>
            </div>
        </div>

        <div class="nav-tabs">
            <a href="#" class="nav-tab active" id="profileTab"> <i class="fas fa-user-alt"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </a>
            <a href="#" class="nav-tab" id="foodRecordsTab"> <i class="fas fa-utensils"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </a>
            <a href="#" class="nav-tab" id="sugarRecordsTab"> <i class="fas fa-tint"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
            </a>
        </div>

        <div class="profile-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>

            <div class="profile-section" id="personalProfileSection">
                <div class="section-header">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <button class="edit-btn" id="editProfileBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <div class="button-group edit-mode-btns" style="display: none;">
                        <button class="cancel-btn" id="cancelEditBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button class="save-btn" id="saveProfileBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </div>

                <form id="profileForm">
                    <div class="profile-grid display-mode">
                        <div class="profile-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <span id="displayFullName"></span>
                            <div class="form-group">
                                <input type="text" id="editFullName" name="full_name" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                            <span id="displayNickname"></span>
                            <div class="form-group">
                                <input type="text" id="editNickname" name="nickname" required>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label>
                            <span id="displayHospitalId"></span>
                            <div class="form-group">
                                <input type="text" id="editHospitalId" name="hospital_id" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                            <span id="displayNationalId"></span>
                            <div class="form-group">
                                <input type="text" id="editNationalId" name="national_id" pattern="[0-9]{13}" maxlength="13" required>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                            <span id="displayBirthDate"></span>
                            <div class="form-group">
                                <input type="date" id="editBirthDate" name="birth_date" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏≠‡∏≤‡∏¢‡∏∏</label>
                            <span id="displayAge"></span>
                            <div class="form-group">
                                <input type="number" id="editAge" name="age" min="15" max="60" readonly>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                            <span id="displayHeight"></span>
                            <div class="form-group">
                                <input type="number" id="editHeight" name="height" min="100" max="200" required step="0.1">
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏Å‡∏Å.)</label>
                            <span id="displayPrePregnancyWeight"></span>
                            <div class="form-group">
                                <input type="number" id="editPrePregnancyWeight" name="pre_pregnancy_weight" min="30" max="150" step="0.1" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.)</label>
                            <span id="displayWeight"></span>
                            <div class="form-group">
                                <input type="number" id="editWeight" name="weight" min="30" max="150" step="0.1" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>BMI</label>
                            <span id="displayBMI"></span>
                            <div class="form-group">
                                <input type="text" id="editBMI" name="bmi" readonly>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                            <span id="displayWeightGain"></span>
                            <div class="form-group">
                                <input type="text" id="editWeightGain" name="weight_gain" readonly>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                            <span id="displayComorbidities"></span>
                            <div class="form-group">
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="editComorbiditiesNo" name="comorbidities_radio" value="‡πÑ‡∏°‡πà‡∏°‡∏µ">
                                        <label for="editComorbiditiesNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="editComorbiditiesYes" name="comorbidities_radio" value="‡∏°‡∏µ">
                                        <label for="editComorbiditiesYes">‡∏°‡∏µ</label>
                                    </div>
                                </div>
                                <div class="conditional-input" id="editComorbiditiesDetail">
                                    <input type="text" id="editComorbidities" name="comorbidities_input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß">
                                </div>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                            <span id="displayPrePregnancyMedications"></span>
                            <div class="form-group">
                                <div class="radio-group">
                                    <div class="radio-item">
                                        <input type="radio" id="editPrePregnancyMedicationsNo" name="pre_pregnancy_medications_radio" value="‡πÑ‡∏°‡πà‡∏°‡∏µ">
                                        <label for="editPrePregnancyMedicationsNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                    </div>
                                    <div class="radio-item">
                                        <input type="radio" id="editPrePregnancyMedicationsYes" name="pre_pregnancy_medications_radio" value="‡∏°‡∏µ">
                                        <label for="editPrePregnancyMedicationsYes">‡∏°‡∏µ</label>
                                    </div>
                                </div>
                                <div class="conditional-input" id="editPrePregnancyMedicationsDetail">
                                    <textarea id="editPrePregnancyMedications" name="pre_pregnancy_medications_input" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                            <span id="displayFetusCount"></span>
                            <div class="form-group">
                                <select id="editFetusCount" name="fetus_count" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å</option>
                                    <option value="1">1 ‡∏Ñ‡∏ô</option>
                                    <option value="2">2 ‡∏Ñ‡∏ô</option>
                                    <option value="3">3 ‡∏Ñ‡∏ô</option>
                                    <option value="4">4 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤</option>
                                </select>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î</label>
                            <span id="displayDueDate"></span>
                            <div class="form-group">
                                <input type="date" id="editDueDate" name="due_date" required>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</label>
                            <span id="displayGestationalWeek"></span>
                            <div class="form-group">
                                <input type="text" id="editGestationalWeek" name="gestational_week" readonly>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏Å‡∏¥‡πÇ‡∏•‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ/‡∏ß‡∏±‡∏ô)</label>
                            <span id="displayCalorieRequired"></span>
                            <div class="form-group">
                                <input type="text" id="editCalorieRequired" name="calorie_required" readonly>
                            </div>
                        </div>
                        <div class="profile-item">
                            <label>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏≤‡∏£‡πå‡∏ö/‡∏ß‡∏±‡∏ô)</label>
                            <span id="displayCarbUnitRequired"></span>
                            <div class="form-group">
                                <input type="text" id="editCarbUnitRequired" name="carb_unit_required" readonly>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏£‡πå‡∏ö (‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏¢‡πá‡∏ô)</label>
                            <span id="displayCarbRatio"></span>
                            <div class="form-group">
                                <div class="carb-ratio-group">
                                    <div><label for="editCarbRatioBreakfast">‡πÄ‡∏ä‡πâ‡∏≤:</label> <input type="number" id="editCarbRatioBreakfast" name="carb_ratio_breakfast" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30 %" required></div>
                                    <div><label for="editCarbRatioLunch">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô:</label> <input type="number" id="editCarbRatioLunch" name="carb_ratio_lunch" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 40 %" required></div>
                                    <div><label for="editCarbRatioDinner">‡πÄ‡∏¢‡πá‡∏ô:</label> <input type="number" id="editCarbRatioDinner" name="carb_ratio_dinner" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30 %" required></div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item full-width">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (PBS Date)</label>
                            <span id="displayPbsDate"></span>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <div class="checkbox-item"><input type="checkbox" id="editMonday" class="sugar-check" value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå"><label for="editMonday">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editTuesday" class="sugar-check" value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£"><label for="editTuesday">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editWednesday" class="sugar-check" value="‡∏û‡∏∏‡∏ò"><label for="editWednesday">‡∏û‡∏∏‡∏ò</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editThursday" class="sugar-check" value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ"><label for="editThursday">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editFriday" class="sugar-check" value="‡∏®‡∏∏‡∏Å‡∏£‡πå"><label for="editFriday">‡∏®‡∏∏‡∏Å‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editSaturday" class="sugar-check" value="‡πÄ‡∏™‡∏≤‡∏£‡πå"><label for="editSaturday">‡πÄ‡∏™‡∏≤‡∏£‡πå</label></div>
                                    <div class="checkbox-item"><input type="checkbox" id="editSunday" class="sugar-check" value="‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"><label for="editSunday">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label></div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label>
                            <span id="displayRegistrationDate"></span>
                            <div class="form-group">
                                <input type="text" id="editRegistrationDate" name="registration_date" readonly>
                            </div>
                        </div>

                    </div>
                </form>
            </div>

            <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
            <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let isLiffReady = false;
        let liffUserId = null;
        let currentProfileData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeLiff();

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Tab
            document.getElementById('profileTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô)
                // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô
            });

            document.getElementById('foodRecordsTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                if (liff.isLoggedIn()) {
                    window.location.href = `${window.location.origin}/food_records.html`;
                } else {
                    console.warn('LIFF not logged in, cannot open food records page.');
                }
            });

            document.getElementById('sugarRecordsTab').addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');
                if (liff.isLoggedIn()) {
                    window.location.href = `${window.location.origin}/sugar_records.html`;
                } else {
                    console.warn('LIFF not logged in, cannot open sugar records page.');
                }
            });

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            document.getElementById('editProfileBtn').addEventListener('click', setEditMode);
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                setDisplayMode(); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á
                displayProfileData(currentProfileData); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            });
            document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö conditional inputs radio
            document.querySelectorAll('input[name="comorbidities_radio"]').forEach(radio => {
                radio.addEventListener('change', () => toggleConditionalInput('comorbidities_radio', 'editComorbiditiesDetail', 'editComorbiditiesYes', 'editComorbidities'));
            });
            document.querySelectorAll('input[name="pre_pregnancy_medications_radio"]').forEach(radio => {
                radio.addEventListener('change', () => toggleConditionalInput('pre_pregnancy_medications_radio', 'editPrePregnancyMedicationsDetail', 'editPrePregnancyMedicationsYes', 'editPrePregnancyMedications'));
            });

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkbox ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.addEventListener('change', checkSugarCheckboxes);
            });

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÉ‡∏™‡πà‡πÉ‡∏ô populateEditForm ‡∏î‡πâ‡∏ß‡∏¢)
            document.getElementById('editBirthDate').addEventListener('change', calculateAge);
            document.getElementById('editHeight').addEventListener('input', calculateBMIAndRecommendations);
            document.getElementById('editPrePregnancyWeight').addEventListener('input', calculateBMIAndRecommendations);
            document.getElementById('editWeight').addEventListener('input', calculateBMIAndRecommendations);
            document.getElementById('editFetusCount').addEventListener('change', calculateBMIAndRecommendations); // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å
            document.getElementById('editDueDate').addEventListener('change', calculateGestationalWeekAndRecommendations);
        });

        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007493917-XdpdZalP" }); // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

                    const profile = await liff.getProfile();
                    liffUserId = profile.userId;
                    document.getElementById('liffDisplayName').innerText = profile.displayName || '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà';

                    await getPatientProfileData(liffUserId);
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
            }
        }

        async function getPatientProfileData(userId) {
            console.log('Fetching user profile for userId:', userId);
            document.getElementById('liffStatus').innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...';

            try {
                const url = '/.netlify/functions/apps-script-proxy';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'getProfile', userId: userId })
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Profile data from Netlify Function:', result);

                if (result.status === 'success' && result.profileData) {
                    currentProfileData = result.profileData; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ
                    displayProfileData(currentProfileData);
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                } else {
                    console.error('Error fetching profile data:', result.message || 'No profile data found.');
                    document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                    document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
                    setTimeout(() => {
                        window.location.href = `index.html`; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å liff.openWindow ‡πÄ‡∏õ‡πá‡∏ô window.location.href
                    }, 3000);
                }

            } catch (error) {
                console.error('Error getting user profile via Netlify Function:', error);
                document.getElementById('liffStatus').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
                setTimeout(() => {
                    window.location.href = `index.html`; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å liff.openWindow ‡πÄ‡∏õ‡πá‡∏ô window.location.href
                }, 5000);
            }
        }

        function displayProfileData(data) {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î display
            document.getElementById('displayFullName').innerText = data.full_name || 'N/A';
            document.getElementById('displayNickname').innerText = data.nickname || 'N/A';
            document.getElementById('displayHospitalId').innerText = data.hospital_id || 'N/A';
            document.getElementById('displayNationalId').innerText = data.national_id || 'N/A';
            document.getElementById('displayBirthDate').innerText = data.birth_date ? new Date(data.birth_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            document.getElementById('displayAge').innerText = data.age ? `${data.age} ‡∏õ‡∏µ` : 'N/A';
            document.getElementById('displayHeight').innerText = data.height ? `${data.height} ‡∏ã‡∏°.` : 'N/A';
            document.getElementById('displayPrePregnancyWeight').innerText = data.pre_pregnancy_weight ? `${data.pre_pregnancy_weight} ‡∏Å‡∏Å.` : 'N/A';
            document.getElementById('displayWeight').innerText = data.weight ? `${data.weight} ‡∏Å‡∏Å.` : 'N/A';
            document.getElementById('displayBMI').innerText = data.bmi || 'N/A';
            document.getElementById('displayWeightGain').innerText = data.weight_gain || 'N/A';

            document.getElementById('displayComorbidities').innerText = data.comorbidities || 'N/A';
            document.getElementById('displayPrePregnancyMedications').innerText = data.pre_pregnancy_medications || 'N/A';

            document.getElementById('displayFetusCount').innerText = data.fetus_count ? `${data.fetus_count} ‡∏Ñ‡∏ô` : 'N/A';
            document.getElementById('displayDueDate').innerText = data.due_date ? new Date(data.due_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';
            document.getElementById('displayGestationalWeek').innerText = data.gestational_week ? `${data.gestational_week} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå` : 'N/A';
            document.getElementById('displayCalorieRequired').innerText = data.calorie_required ? `${data.calorie_required} kcal` : 'N/A';
            document.getElementById('displayCarbUnitRequired').innerText = data.carb_unit_required ? `${data.carb_unit_required} ‡∏´‡∏ô‡πà‡∏ß‡∏¢` : 'N/A';

            // Carb Ratio
            let carbRatioParsed = null;
            if (data.carb_ratio) {
                try {
                    carbRatioParsed = typeof data.carb_ratio === 'string' ? JSON.parse(data.carb_ratio) : data.carb_ratio;
                } catch (e) {
                    console.error("Error parsing carb_ratio for display:", e);
                }
            }
            const carbRatioText = (carbRatioParsed && typeof carbRatioParsed === 'object')
                                    ? `‡πÄ‡∏ä‡πâ‡∏≤: ${carbRatioParsed.breakfast || 0}% / ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô: ${carbRatioParsed.lunch || 0}% / ‡πÄ‡∏¢‡πá‡∏ô: ${carbRatioParsed.dinner || 0}%`
                                    : 'N/A';
            document.getElementById('displayCarbRatio').innerText = carbRatioText;

            // PBS Date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)
            const displayPbsDateElement = document.getElementById('displayPbsDate');
            let pbsDateParsed = null;
            if (data.pbs_date) {
                try {
                    pbsDateParsed = typeof data.pbs_date === 'string' ? JSON.parse(data.pbs_date) : data.pbs_date;
                } catch (e) {
                    console.error("Error parsing pbs_date for display:", e);
                }
            }

            if (displayPbsDateElement) {
                if (pbsDateParsed && Array.isArray(pbsDateParsed) && pbsDateParsed.length > 0) {
                    displayPbsDateElement.innerText = pbsDateParsed.join(', ');
                } else {
                    displayPbsDateElement.innerText = '‡πÑ‡∏°‡πà‡∏°‡∏µ'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array
                }
            }

            document.getElementById('displayRegistrationDate').innerText = data.registration_date ? new Date(data.registration_date).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A';

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πâ‡∏ß‡∏¢
            populateEditForm(data);
            setDisplayMode(); // ‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        }

        // ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function setDisplayMode() {
            document.querySelector('.profile-grid').classList.remove('edit-mode');
            document.querySelector('.profile-grid').classList.add('display-mode');
            document.getElementById('editProfileBtn').style.display = 'block';
            document.querySelector('.edit-mode-btns').style.display = 'none';

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ input fields ‡πÄ‡∏õ‡πá‡∏ô readonly ‡πÅ‡∏•‡∏∞ disabled ‡πÉ‡∏ô display mode
            const formInputs = document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea');
            formInputs.forEach(input => {
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('disabled', 'disabled');
            });
        }

        // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function setEditMode() {
            document.querySelector('.profile-grid').classList.add('edit-mode');
            document.querySelector('.profile-grid').classList.remove('display-mode');
            document.getElementById('editProfileBtn').style.display = 'none';
            document.querySelector('.edit-mode-btns').style.display = 'flex';

            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ input fields ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            const formInputs = document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea');
            formInputs.forEach(input => {
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
            });
            
            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            populateEditForm(currentProfileData);
            checkConditionalInputs('comorbidities_radio', 'editComorbiditiesDetail', 'editComorbiditiesYes', 'editComorbidities');
            checkConditionalInputs('pre_pregnancy_medications_radio', 'editPrePregnancyMedicationsDetail', 'editPrePregnancyMedicationsYes', 'editPrePregnancyMedications');
            checkSugarCheckboxes(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ checkbox ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
        }

        function populateEditForm(data) {
            if (!data) {
                console.warn("No data provided to populateEditForm.");
                return;
            }

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('editFullName').value = data.full_name || '';
            document.getElementById('editNickname').value = data.nickname || '';
            document.getElementById('editHospitalId').value = data.hospital_id || '';
            document.getElementById('editNationalId').value = data.national_id || '';
            // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ input type="date" ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏öYYYY-MM-DD ***
            document.getElementById('editBirthDate').value = data.birth_date ? formatDateForInput(data.birth_date) : '';
            document.getElementById('editAge').value = data.age || ''; // ‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
            document.getElementById('editHeight').value = data.height || '';
            document.getElementById('editPrePregnancyWeight').value = data.pre_pregnancy_weight || '';
            document.getElementById('editWeight').value = data.weight || '';
            document.getElementById('editBMI').value = data.bmi || '';
            document.getElementById('editWeightGain').value = data.weight_gain || '';

            // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (Radio Buttons ‡πÅ‡∏•‡∏∞ Conditional Input)
            const editComorbiditiesNo = document.getElementById('editComorbiditiesNo');
            const editComorbiditiesYes = document.getElementById('editComorbiditiesYes');
            const editComorbiditiesDetail = document.getElementById('editComorbiditiesDetail');
            const editComorbiditiesInput = document.getElementById('editComorbidities');

            if (data.comorbidities === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                editComorbiditiesNo.checked = true;
                editComorbiditiesDetail.classList.remove('show');
                editComorbiditiesInput.value = '';
                editComorbiditiesInput.required = false;
            } else if (data.comorbidities && data.comorbidities !== 'N/A' && data.comorbidities !== '') {
                editComorbiditiesYes.checked = true;
                editComorbiditiesDetail.classList.add('show');
                editComorbiditiesInput.value = data.comorbidities; // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á‡πÜ
                editComorbiditiesInput.required = true;
            } else {
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ'
                editComorbiditiesNo.checked = true;
                editComorbiditiesDetail.classList.remove('show');
                editComorbiditiesInput.value = '';
                editComorbiditiesInput.required = false;
            }

            // ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (Radio Buttons ‡πÅ‡∏•‡∏∞ Conditional Input)
            const editMedicationsNo = document.getElementById('editPrePregnancyMedicationsNo');
            const editMedicationsYes = document.getElementById('editPrePregnancyMedicationsYes');
            const editMedicationsDetail = document.getElementById('editPrePregnancyMedicationsDetail');
            const editMedicationsInput = document.getElementById('editPrePregnancyMedications');

            if (data.pre_pregnancy_medications === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                editMedicationsNo.checked = true;
                editMedicationsDetail.classList.remove('show');
                editMedicationsInput.value = '';
                editMedicationsInput.required = false;
            } else if (data.pre_pregnancy_medications && data.pre_pregnancy_medications !== 'N/A' && data.pre_pregnancy_medications !== '') {
                editMedicationsYes.checked = true;
                editMedicationsDetail.classList.add('show');
                editMedicationsInput.value = data.pre_pregnancy_medications; // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ï‡∏£‡∏á‡πÜ
                editMedicationsInput.required = true;
            } else {
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ'
                editMedicationsNo.checked = true;
                editMedicationsDetail.classList.remove('show');
                editMedicationsInput.value = '';
                editMedicationsInput.required = false;
            }

            document.getElementById('editFetusCount').value = data.fetus_count || '1';
            // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ input type="date" ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏öYYYY-MM-DD ***
            document.getElementById('editDueDate').value = data.due_date ? formatDateForInput(data.due_date) : '';
            document.getElementById('editGestationalWeek').value = data.gestational_week || '';
            document.getElementById('editCalorieRequired').value = data.calorie_required || '';
            document.getElementById('editCarbUnitRequired').value = data.carb_unit_required || '';

            // Carb Ratio
            let carbRatioParsed = null;
            if (data.carb_ratio) {
                try {
                    carbRatioParsed = typeof data.carb_ratio === 'string' ? JSON.parse(data.carb_ratio) : data.carb_ratio;
                } catch (e) {
                    console.error("Error parsing carb_ratio for edit form:", e);
                }
            }
            if (carbRatioParsed && typeof carbRatioParsed === 'object') {
                document.getElementById('editCarbRatioBreakfast').value = carbRatioParsed.breakfast || '';
                document.getElementById('editCarbRatioLunch').value = carbRatioParsed.lunch || '';
                document.getElementById('editCarbRatioDinner').value = carbRatioParsed.dinner || '';
            } else {
                document.getElementById('editCarbRatioBreakfast').value = '';
                document.getElementById('editCarbRatioLunch').value = '';
                document.getElementById('editCarbRatioDinner').value = '';
            }

            // PBS Date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)
            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.checked = false; // clear all first
                checkbox.disabled = false; // ensure all are enabled before setting
            });
            let pbsDateParsed = null;
            if (data.sugar_check_days) {
                try {
                    pbsDateParsed = typeof data.sugar_check_days === 'string' ? JSON.parse(data.sugar_check_days) : data.sugar_check_days;
                } catch (e) {
                    console.error("Error parsing sugar_check_days for edit form:", e);
                }
            }
            if (pbsDateParsed && Array.isArray(pbsDateParsed)) {
                pbsDateParsed.forEach(day => {
                    const checkbox = document.querySelector(`.sugar-check[value="${day}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            checkSugarCheckboxes();

            document.getElementById('editRegistrationDate').value = data.registration_date || '';
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏öYYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date"
         * @param {string|Date} dateInput - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô string ‡∏´‡∏£‡∏∑‡∏≠ Date object
         * @returns {string} - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏öYYYY-MM-DD
         */
        function formatDateForInput(dateInput) {
            if (!dateInput) return '';
            let date = new Date(dateInput);
            if (isNaN(date.getTime())) { // Check if date is invalid
                console.warn("Invalid date format detected:", dateInput);
                return ''; 
            }
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function handleSaveProfile(event) {
            event.preventDefault(); // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ form submit ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥

            if (!isLiffReady || !liffUserId) {
                console.warn('LIFF not ready or userId not available for saving profile.');
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (HTML5 validation)
            const form = document.getElementById('profileForm');
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ validate ‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á enable ‡∏Å‡πà‡∏≠‡∏ô
            form.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('disabled'));

            if (!form.checkValidity()) {
                form.reportValidity(); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏Ç‡∏≠‡∏á input ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                document.getElementById('errorMessage').style.display = 'block';
                // Re-disable inputs in display mode after validation fails
                setTimeout(() => {
                    if (document.getElementById('editProfileBtn').style.display === 'block') { // If still in display mode
                        form.querySelectorAll('input, select, textarea').forEach(el => el.setAttribute('disabled', 'disabled'));
                    }
                }, 100);
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            const pbsDates = Array.from(document.querySelectorAll('.sugar-check:checked')).map(cb => cb.value);

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input fields ‡∏ó‡∏µ‡πà‡∏°‡∏µ 'edit' prefix
            const formData = {
                userId: liffUserId,
                full_name: document.getElementById('editFullName').value,
                nickname: document.getElementById('editNickname').value,
                hospital_id: document.getElementById('editHospitalId').value,
                national_id: document.getElementById('editNationalId').value,
                birth_date: document.getElementById('editBirthDate').value,
                // age ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                comorbidities: document.querySelector('input[name="comorbidities_radio"]:checked')?.value || '',
                comorbiditiesText: document.getElementById('editComorbidities').value,
                pre_pregnancy_medications: document.querySelector('input[name="pre_pregnancy_medications_radio"]:checked')?.value || '',
                pre_pregnancy_medicationsText: document.getElementById('editPrePregnancyMedications').value,
                pre_pregnancy_weight: document.getElementById('editPrePregnancyWeight').value,
                weight: document.getElementById('editWeight').value,
                height: document.getElementById('editHeight').value,
                // bmi ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                fetus_count: document.getElementById('editFetusCount').value,
                due_date: document.getElementById('editDueDate').value,
                // gestational_week ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                carb_ratio: {
                    breakfast: document.getElementById('editCarbRatioBreakfast').value,
                    lunch: document.getElementById('editCarbRatioLunch').value,
                    dinner: document.getElementById('editCarbRatioDinner').value
                },
                // calorie_required ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                // carb_unit_required ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                // weight_gain ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script
                sugar_check_days: pbsDates, // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                // registration_date ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å frontend ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ update
                fetal_movement_notified: currentProfileData?.fetal_movement_notified || false // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
            };

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß/‡∏¢‡∏≤ ‡∏Ñ‡∏ß‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á text ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            if (formData.comorbidities === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                formData.comorbiditiesText = '';
            }
            if (formData.pre_pregnancy_medications === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                formData.pre_pregnancy_medicationsText = '';
            }

            // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Apps Script ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ action updateProfile ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            // ‡πÅ‡∏•‡∏∞ saveData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á action: 'updateProfile' ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏°
            const actionType = currentProfileData && currentProfileData.userId === liffUserId ? 'updateProfile' : 'saveData'; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å currentProfileData

            try {
                const response = await fetch(APPS_SCRIPT_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: actionType,
                        ...formData // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    })
                });
                const result = await response.json();
                console.log('Save profile result:', result);

                if (result.status === 'success') {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô error message ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏™‡∏î‡∏á
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï currentProfileData ‡∏à‡∏≤‡∏Å response ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ formData
                    // ‡∏ñ‡πâ‡∏≤ Apps Script ‡∏Ñ‡∏∑‡∏ô profileData ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡∏Å‡πá‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å response
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ formData ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
                    currentProfileData = result.profileData || { ...currentProfileData, ...formData }; 

                    displayProfileData(currentProfileData); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                    // setDisplayMode(); // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô displayProfileData ‡πÅ‡∏•‡πâ‡∏ß)
                } else {
                    document.getElementById('errorMessage').innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ' + (result.message || 'Unknown error');
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                console.error('Network or parsing error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                setTimeout(() => { // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    document.getElementById('successMessage').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
            }
        }

        // Helper functions for dynamic calculations
        function calculateAge() {
            const birthDateStr = document.getElementById('editBirthDate').value; // ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å input field
            if (birthDateStr) {
                const birthDate = new Date(birthDateStr);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('editAge').value = age; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input field
            } else {
                document.getElementById('editAge').value = '';
            }
        }

        function calculateBMI(weightKg, heightCm) {
            if (isNaN(weightKg) || isNaN(heightCm) || heightCm <= 0) {
                return '';
            }
            const heightM = heightCm / 100;
            return (weightKg / (heightM * heightM)).toFixed(2);
        }

        function calculateGestationalWeek(dueDateStr) {
            if (!dueDateStr) return '';
            try {
                const due = new Date(dueDateStr);
                const today = new Date();
                const diffTime = Math.abs(due.getTime() - today.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalWeeks = 40; // Full term pregnancy is 40 weeks
                
                if (today < due) {
                    return Math.max(0, totalWeeks - Math.floor(diffDays / 7));
                } else {
                    return totalWeeks + Math.floor(diffDays / 7);
                }
            } catch (e) {
                console.error('Error calculating gestational week:', e.message);
                return '';
            }
        }

        function calculateCalorieRequired(prePregnancyBMI, gestationalWeek, prePregnancyWeight) {
            if (isNaN(prePregnancyBMI) || isNaN(gestationalWeek) || isNaN(prePregnancyWeight) || gestationalWeek < 0) {
                return '';
            }
            let bmrFactor;
            if (prePregnancyBMI < 18.5) { bmrFactor = 35; }
            else if (prePregnancyBMI >= 18.5 && prePregnancyBMI <= 24.9) { bmrFactor = 30; }
            else if (prePregnancyBMI >= 25 && prePregnancyBMI <= 29.9) { bmrFactor = 25; }
            else { bmrFactor = 23; }

            let extraCalories = 0;
            if (gestationalWeek >= 14 && gestationalWeek <= 28) { extraCalories = 300; }
            else if (gestationalWeek > 28) { extraCalories = 450; }
            return ((prePregnancyWeight * bmrFactor) + extraCalories).toFixed(0);
        }

        function calculateCarbUnitRequired(calorieRequired) {
            if (isNaN(calorieRequired) || calorieRequired <= 0) {
                return '';
            }
            const totalCarbCalories = calorieRequired * 0.55;
            return (totalCarbCalories / 60).toFixed(1);
        }

        function calculateWeightGain(prePregnancyBMI) {
            if (isNaN(prePregnancyBMI)) { return ''; }
            if (prePregnancyBMI < 18.5) { return '12.5 - 18 kg'; }
            else if (prePregnancyBMI >= 18.5 && prePregnancyBMI <= 24.9) { return '11.5 - 16 kg'; }
            else if (prePregnancyBMI >= 25 && prePregnancyBMI <= 29.9) { return '7 - 11.5 kg'; }
            else { return '5 - 9 kg'; }
        }

        function calculateBMIAndRecommendations() {
            const weight = parseFloat(document.getElementById('editWeight').value);
            const height = parseFloat(document.getElementById('editHeight').value);
            const prePregnancyWeight = parseFloat(document.getElementById('editPrePregnancyWeight').value);
            const dueDateStr = document.getElementById('editDueDate').value;
            const fetusCount = parseInt(document.getElementById('editFetusCount').value || '1');

            const bmiVal = calculateBMI(weight, height);
            document.getElementById('editBMI').value = bmiVal;

            const prePregnancyBMI = calculateBMI(prePregnancyWeight, height);
            const gestationalWeek = calculateGestationalWeek(dueDateStr);
            

            let calorieReq = 'N/A';
            if (fetusCount >= 2) {
                if (!isNaN(prePregnancyWeight)) {
                    calorieReq = (prePregnancyWeight * 45).toFixed(0);
                }
            } else {
                if (prePregnancyBMI && gestationalWeek !== '' && !isNaN(prePregnancyWeight)) {
                    calorieReq = calculateCalorieRequired(parseFloat(prePregnancyBMI), parseInt(gestationalWeek), prePregnancyWeight);
                }
            }
            document.getElementById('editCalorieRequired').value = calorieReq;

            const carbUnitReq = calculateCarbUnitRequired(parseFloat(calorieReq));
            document.getElementById('editCarbUnitRequired').value = carbUnitReq;
            
            document.getElementById('editWeightGain').value = calculateWeightGain(parseFloat(prePregnancyBMI));
        }

        function calculateGestationalWeekAndRecommendations() {
            const dueDateStr = document.getElementById('editDueDate').value;
            const gestationalWeekVal = calculateGestationalWeek(dueDateStr);
            document.getElementById('editGestationalWeek').value = gestationalWeekVal;

            calculateBMIAndRecommendations(); // Recalculate other fields that depend on gestational week
        }

        function toggleConditionalInput(radioName, inputContainerId, yesRadioId, inputFieldId) {
            const yesRadio = document.getElementById(yesRadioId);
            const inputContainer = document.getElementById(inputContainerId);
            const inputField = document.getElementById(inputFieldId);

            if (yesRadio && inputContainer && inputField) {
                if (yesRadio.checked) {
                    inputContainer.classList.add('show');
                    inputField.required = true;
                } else {
                    inputContainer.classList.remove('show');
                    inputField.required = false;
                    // Clear the input field if 'No' is selected
                    inputField.value = '';
                }
            }
        }
    </script>
</body>
</html>
