<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h1>
            <p>‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</p>
        </div>
        
        <div class="form-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>
            
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ -->
            <div id="mainContentArea">
                <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Registration/Edit Form) -->
                <form id="patientForm" class="page-section" style="display: none;"> 
                    <div class="form-section">
                        <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="full_name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                                <input type="text" id="full_name" name="full_name" required>
                            </div>
                            <div class="form-group">
                                <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô *</label>
                                <input type="text" id="nickname" name="nickname" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hospital_id">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• *</label>
                                <input type="text" id="hospital_id" name="hospital_id" required>
                            </div>
                            <div class="form-group">
                                <label for="national_id">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô *</label>
                                <input type="text" id="national_id" name="national_id" pattern="[0-9]{13}" maxlength="13" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="birth_date">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î *</label>
                                <input type="date" id="birth_date" name="birth_date" required>
                            </div>
                            <div class="form-group">
                                <label for="height">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.) *</label>
                                <input type="number" id="height" name="height" min="100" max="200" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
                        
                        <div class="form-group full-width">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß *</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="chronicDiseaseNo" name="chronicDisease" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" required>
                                    <label for="chronicDiseaseNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="chronicDiseaseYes" name="chronicDisease" value="‡∏°‡∏µ" required>
                                    <label for="chronicDiseaseYes">‡∏°‡∏µ</label>
                                </div>
                            </div>
                            <div class="conditional-input" id="chronicDiseaseDetail">
                                <input type="text" id="comorbidities" name="comorbidities" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß">
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå *</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="medicationNo" name="medication" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" required>
                                    <label for="medicationNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="medicationYes" name="medication" value="‡∏°‡∏µ" required>
                                    <label for="medicationYes">‡∏°‡∏µ</label>
                                </div>
                            </div>
                            <div class="conditional-input" id="medicationDetail">
                                <textarea id="pre_pregnancy_medications" name="pre_pregnancy_medications" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pre_pregnancy_weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏Å‡∏Å.) *</label>
                                <input type="number" id="pre_pregnancy_weight" name="pre_pregnancy_weight" min="30" max="150" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.) *</label>
                                <input type="number" id="weight" name="weight" min="30" max="150" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fetus_count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå *</label>
                                <select id="fetus_count" name="fetus_count" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å</option>
                                    <option value="1">1 ‡∏Ñ‡∏ô</option>
                                    <option value="2">2 ‡∏Ñ‡∏ô</option>
                                    <option value="3">3 ‡∏Ñ‡∏ô</option>
                                    <option value="4">4 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="due_date">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î *</label>
                                <input type="date" id="due_date" name="due_date" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å</h3>
                        
                        <div class="carb-ratio-group">
                            <div class="form-group">
                                <label for="main_ratio_breakfast">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤ (Breakfast) *</label>
                                <input type="number" id="main_ratio_breakfast" name="main_ratio_breakfast" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" required>
                            </div>
                            <div class="form-group">
                                <label for="main_ratio_lunch">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (Lunch) *</label>
                                <input type="number" id="main_ratio_lunch" name="main_ratio_lunch" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4" required>
                            </div>
                            <div class="form-group">
                                <label for="main_ratio_dinner">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô (Dinner) *</label>
                                <input type="number" id="main_ratio_dinner" name="main_ratio_dinner" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="section-title">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏á</h3>
                        
                        <div class="carb-ratio-group">
                            <div class="form-group">
                                <label for="snack_ratio_morning">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤ (Morning Snack) *</label>
                                <input type="number" id="snack_ratio_morning" name="snack_ratio_morning" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" required>
                            </div>
                            <div class="form-group">
                                <label for="snack_ratio_afternoon">‡∏°‡∏∑‡πâ‡∏≠‡∏ö‡πà‡∏≤‡∏¢ (Afternoon Snack) *</label>
                                <input type="number" id="snack_ratio_afternoon" name="snack_ratio_afternoon" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.5" required>
                            </div>
                            <div class="form-group">
                                <label for="snack_ratio_evening">‡∏°‡∏∑‡πâ‡∏≠‡∏Ñ‡πà‡∏≥ (Evening Snack) *</label>
                                <input type="number" id="snack_ratio_evening" name="snack_ratio_evening" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0.5" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3 class="section-title">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ß‡∏±‡∏ô)</h3>
                        
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="monday" class="sugar-check" value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">
                                <label for="monday">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="tuesday" class="sugar-check" value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">
                                <label for="tuesday">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="wednesday" class="sugar-check" value="‡∏û‡∏∏‡∏ò">
                                <label for="wednesday">‡∏û‡∏∏‡∏ò</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="thursday" class="sugar-check" value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">
                                <label for="thursday">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="friday" class="sugar-check" value="‡∏®‡∏∏‡∏Å‡∏£‡πå">
                                <label for="friday">‡∏®‡∏∏‡∏Å‡∏£‡πå</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="saturday" class="sugar-check" value="‡πÄ‡∏™‡∏≤‡∏£‡πå">
                                <label for="saturday">‡πÄ‡∏™‡∏≤‡∏£‡πå</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="sunday" class="sugar-check" value="‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå">
                                <label for="sunday">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn" disabled>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    
                    <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
                    <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                </form>

                <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (Profile View Page) -->
                <div id="profileViewPage" class="page-section" style="display: none;">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                    <div class="profile-display">
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="display_full_name"></span></p>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> <span id="display_nickname"></span></p>
                        <p><strong>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•:</strong> <span id="display_hospital_id"></span></p>
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> <span id="display_national_id"></span></p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> <span id="display_birth_date"></span></p>
                        <p><strong>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</strong> <span id="display_height"></span> ‡∏ã‡∏°.</p>
                        <p><strong>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> <span id="display_comorbidities"></span></p>
                        <p><strong>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå:</strong> <span id="display_pre_pregnancy_medications"></span></p>
                        <p><strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå:</strong> <span id="display_pre_pregnancy_weight"></span> ‡∏Å‡∏Å.</p>
                        <p><strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <span id="display_weight"></span> ‡∏Å‡∏Å.</p>
                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå:</strong> <span id="display_fetus_count"></span> ‡∏Ñ‡∏ô</p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î:</strong> <span id="display_due_date"></span></p>
                        <p><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏¢‡πá‡∏ô):</strong> <span id="display_main_ratio"></span></p>
                        <p><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏á (‡πÄ‡∏ä‡πâ‡∏≤/‡∏ö‡πà‡∏≤‡∏¢/‡∏Ñ‡πà‡∏≥):</strong> <span id="display_snack_ratio"></span></p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•:</strong> <span id="display_sugar_check_days"></span></p>
                        <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> <span id="display_age"></span> ‡∏õ‡∏µ</p>
                        <p><strong>BMI:</strong> <span id="display_bmi"></span></p>
                        <p><strong>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ñ‡∏£‡∏£‡∏†‡πå:</strong> <span id="display_gestational_week"></span> ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
                        <p><strong>‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> <span id="display_calorie_required"></span> kcal</p>
                        <p><strong>‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏¢‡∏π‡∏ô‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> <span id="display_carb_unit_required"></span> ‡∏¢‡∏π‡∏ô‡∏¥‡∏ï</p>
                        <p><strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°:</strong> <span id="display_weight_gain"></span> ‡∏Å‡∏Å.</p>
                    </div>
                    <button id="editProfileBtn" class="submit-btn edit-btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>

                <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Food History Page) -->
                <div id="foodHistoryPage" class="page-section" style="display: none;">
                    <h3 class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                    <p>‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                    <!-- TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>

                <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (Blood Sugar History Page) -->
                <div id="sugarHistoryPage" class="page-section" style="display: none;">
                    <h3 class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h3>
                    <p>‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                    <!-- TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>

            <!-- ‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Navigation Buttons) -->
            <div class="navigation-buttons">
                <button id="navProfile" class="nav-btn active">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
                <button id="navFood" class="nav-btn">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                <button id="navSugar" class="nav-btn">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</button>
            </div>

        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let isLiffReady = false;
        let liffUserId = null; // ‡πÄ‡∏Å‡πá‡∏ö userId ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡∏ñ‡∏∂‡∏á
        let currentUserProfile = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÑ‡∏î‡πâ
        let currentPage = 'patientForm'; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
        function showPage(pageId) {
            const pages = ['patientForm', 'profileViewPage', 'foodHistoryPage', 'sugarHistoryPage'];
            pages.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
            currentPage = pageId; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (pageId === 'patientForm' && currentUserProfile) { // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                document.getElementById('navProfile').classList.add('active');
            } else if (pageId === 'profileViewPage') {
                document.getElementById('navProfile').classList.add('active');
            } else if (pageId === 'foodHistoryPage') {
                document.getElementById('navFood').classList.add('active');
            } else if (pageId === 'sugarHistoryPage') {
                document.getElementById('navSugar').classList.add('active');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function populateProfileView(profileData) {
            document.getElementById('display_full_name').innerText = profileData.full_name || '-';
            document.getElementById('display_nickname').innerText = profileData.nickname || '-';
            document.getElementById('display_hospital_id').innerText = profileData.hospital_id || '-';
            document.getElementById('display_national_id').innerText = profileData.national_id || '-';
            document.getElementById('display_birth_date').innerText = profileData.birth_date || '-';
            document.getElementById('display_height').innerText = (profileData.height ? profileData.height + ' ‡∏ã‡∏°.' : '-');

            // ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß
            document.getElementById('display_comorbidities').innerText = profileData.comorbidities || '-';
            // ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå
            document.getElementById('display_pre_pregnancy_medications').innerText = profileData.pre_pregnancy_medications || '-';

            document.getElementById('display_pre_pregnancy_weight').innerText = (profileData.pre_pregnancy_weight ? profileData.pre_pregnancy_weight + ' ‡∏Å‡∏Å.' : '-');
            document.getElementById('display_weight').innerText = (profileData.weight ? profileData.weight + ' ‡∏Å‡∏Å.' : '-');
            document.getElementById('display_fetus_count').innerText = (profileData.fetus_count ? profileData.fetus_count + ' ‡∏Ñ‡∏ô' : '-');
            document.getElementById('display_due_date').innerText = profileData.due_date || '-';

            // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
            if (profileData.main_ratio) {
                const mainRatio = typeof profileData.main_ratio === 'string' ? JSON.parse(profileData.main_ratio) : profileData.main_ratio;
                document.getElementById('display_main_ratio').innerText = `‡πÄ‡∏ä‡πâ‡∏≤: ${mainRatio.breakfast || 0}, ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô: ${mainRatio.lunch || 0}, ‡πÄ‡∏¢‡πá‡∏ô: ${mainRatio.dinner || 0}`;
            } else {
                document.getElementById('display_main_ratio').innerText = '-';
            }

            // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏á
            if (profileData.snack_ratio) {
                const snackRatio = typeof profileData.snack_ratio === 'string' ? JSON.parse(profileData.snack_ratio) : profileData.snack_ratio;
                document.getElementById('display_snack_ratio').innerText = `‡πÄ‡∏ä‡πâ‡∏≤: ${snackRatio.morning || 0}, ‡∏ö‡πà‡∏≤‡∏¢: ${snackRatio.afternoon || 0}, ‡∏Ñ‡πà‡∏≥: ${snackRatio.evening || 0}`;
            } else {
                document.getElementById('display_snack_ratio').innerText = '-';
            }

            document.getElementById('display_sugar_check_days').innerText = (profileData.sugar_check_days && Array.isArray(profileData.sugar_check_days) ? profileData.sugar_check_days.join(', ') : '-');
            
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
            document.getElementById('display_age').innerText = profileData.age || '-';
            document.getElementById('display_bmi').innerText = profileData.bmi || '-';
            document.getElementById('display_gestational_week').innerText = (profileData.gestational_week ? profileData.gestational_week + ' ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' : '-');
            document.getElementById('display_calorie_required').innerText = (profileData.calorie_required ? profileData.calorie_required + ' kcal' : '-');
            document.getElementById('display_carb_unit_required').innerText = (profileData.carb_unit_required ? profileData.carb_unit_required + ' ‡∏¢‡∏π‡∏ô‡∏¥‡∏ï' : '-');
            document.getElementById('display_weight_gain').innerText = profileData.weight_gain || '-';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
        function populateProfileForm(profileData) {
            document.getElementById('full_name').value = profileData.full_name || '';
            document.getElementById('nickname').value = profileData.nickname || '';
            document.getElementById('hospital_id').value = profileData.hospital_id || '';
            document.getElementById('national_id').value = profileData.national_id || '';
            document.getElementById('birth_date').value = profileData.birth_date || '';
            document.getElementById('height').value = profileData.height || '';

            if (profileData.comorbidities === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                document.getElementById('chronicDiseaseNo').checked = true;
                document.getElementById('chronicDiseaseDetail').classList.remove('show');
            } else if (profileData.comorbidities) {
                document.getElementById('chronicDiseaseYes').checked = true;
                document.getElementById('chronicDiseaseDetail').classList.add('show');
                document.getElementById('comorbidities').value = profileData.comorbidities;
            }

            if (profileData.pre_pregnancy_medications === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
                document.getElementById('medicationNo').checked = true;
                document.getElementById('medicationDetail').classList.remove('show');
            } else if (profileData.pre_pregnancy_medications) {
                document.getElementById('medicationYes').checked = true;
                document.getElementById('medicationDetail').classList.add('show');
                document.getElementById('pre_pregnancy_medications').value = profileData.pre_pregnancy_medications;
            }

            document.getElementById('pre_pregnancy_weight').value = profileData.pre_pregnancy_weight || '';
            document.getElementById('weight').value = profileData.weight || '';
            document.getElementById('fetus_count').value = profileData.fetus_count || '';
            document.getElementById('due_date').value = profileData.due_date || '';

            if (profileData.main_ratio) {
                try {
                    const mainRatio = typeof profileData.main_ratio === 'string' ? JSON.parse(profileData.main_ratio) : profileData.main_ratio;
                    document.getElementById('main_ratio_breakfast').value = mainRatio.breakfast || '';
                    document.getElementById('main_ratio_lunch').value = mainRatio.lunch || '';
                    document.getElementById('main_ratio_dinner').value = mainRatio.dinner || '';
                } catch (e) {
                    console.error("Error parsing main_ratio for form:", e);
                }
            }

            if (profileData.snack_ratio) {
                try {
                    const snackRatio = typeof profileData.snack_ratio === 'string' ? JSON.parse(profileData.snack_ratio) : profileData.snack_ratio;
                    document.getElementById('snack_ratio_morning').value = snackRatio.morning || '';
                    document.getElementById('snack_ratio_afternoon').value = snackRatio.afternoon || '';
                    document.getElementById('snack_ratio_evening').value = snackRatio.evening || '';
                } catch (e) {
                    console.error("Error parsing snack_ratio for form:", e);
                }
            }

            if (profileData.sugar_check_days && Array.isArray(profileData.sugar_check_days)) {
                document.querySelectorAll('.sugar-check').forEach(checkbox => {
                    checkbox.checked = profileData.sugar_check_days.includes(checkbox.value);
                });
                const event = new Event('change');
                document.getElementById('monday').dispatchEvent(event); // ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ disabled
            }
        }

        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007493917-XdpdZalP" }); // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    
                    const profile = await liff.getProfile();
                    liffUserId = profile.userId; // ‡πÄ‡∏Å‡πá‡∏ö userId

                    await checkUserProfile(liffUserId); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå

                    document.querySelector('.submit-btn').disabled = false;
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
                // ‡∏´‡∏≤‡∏Å LIFF ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                // ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ UX ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
            }
        }

        async function checkUserProfile(userId) {
            console.log('Checking user profile for userId:', userId);
            try {
                const url = '/.netlify/functions/apps-script-proxy'; 
                const response = await fetch(`${url}?action=checkUser&userId=${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('User check response from Netlify Function:', result);

                if (result.status === 'profile_exists') {
                    currentUserProfile = result.profileData; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                    populateProfileView(currentUserProfile); // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                    showPage('profileViewPage'); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                } else if (result.status === 'new_user') {
                    showPage('patientForm'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà
                } else {
                    console.error('Error from Apps Script during checkUser:', result.message);
                    showPage('patientForm'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                }

            } catch (error) {
                console.error('Error checking user profile via Netlify Function:', error);
                showPage('patientForm'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();

            if (!isLiffReady || !liffUserId) { 
                console.warn('LIFF not ready or userId not available.');
                return;
            }

            const selectedSugarCheck = Array.from(document.querySelectorAll('.sugar-check:checked')).map(cb => cb.value);
            if (selectedSugarCheck.length !== 2) { 
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 2 ‡∏ß‡∏±‡∏ô';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 5000);
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                let comorbidities = '';
                const chronicDiseaseRadio = document.querySelector('input[name="chronicDisease"]:checked');
                if (chronicDiseaseRadio) {
                    comorbidities = chronicDiseaseRadio.value === '‡∏°‡∏µ' ? (document.getElementById('comorbidities').value || '') : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                } else {
                    comorbidities = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                }

                let prePregMedications = '';
                const medicationRadio = document.querySelector('input[name="medication"]:checked');
                if (medicationRadio) {
                    prePregMedications = medicationRadio.value === '‡∏°‡∏µ' ? (document.getElementById('pre_pregnancy_medications').value || '') : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                } else {
                    prePregMedications = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                }

                const formData = {
                    action: 'updateProfile', 
                    userId: liffUserId, 
                    data: {
                        full_name: document.getElementById('full_name').value || '',
                        nickname: document.getElementById('nickname').value || '',
                        hospital_id: document.getElementById('hospital_id').value || '',
                        national_id: document.getElementById('national_id').value || '',
                        birth_date: document.getElementById('birth_date').value || '',
                        comorbidities,
                        pre_pregnancy_medications: prePregMedications,
                        pre_pregnancy_weight: parseFloat(document.getElementById('pre_pregnancy_weight').value) || 0,
                        weight: parseFloat(document.getElementById('weight').value) || 0,
                        height: parseFloat(document.getElementById('height').value) || 0,
                        fetus_count: parseInt(document.getElementById('fetus_count').value) || 0,
                        due_date: document.getElementById('due_date').value || '',
                        
                        main_ratio: {
                            breakfast: parseFloat(document.getElementById('main_ratio_breakfast').value) || 0,
                            lunch: parseFloat(document.getElementById('main_ratio_lunch').value) || 0,
                            dinner: parseFloat(document.getElementById('main_ratio_dinner').value) || 0
                        },
                        snack_ratio: {
                            morning: parseFloat(document.getElementById('snack_ratio_morning').value) || 0,
                            afternoon: parseFloat(document.getElementById('snack_ratio_afternoon').value) || 0,
                            evening: parseFloat(document.getElementById('snack_ratio_evening').value) || 0
                        },
                        sugar_check_days: selectedSugarCheck
                    }
                };

                console.log('Sending data:', JSON.stringify(formData, null, 2));

                const url = '/.netlify/functions/apps-script-proxy'; 
                console.log('Attempting to fetch to Netlify Function:', url);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorDetails = await response.text(); 
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Server response from Netlify Function (saveData):', result);

                if (result.status === 'success') {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï currentUserProfile ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                    currentUserProfile = formData.data; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    populateProfileView(currentUserProfile);
                    showPage('profileViewPage'); 

                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                        document.querySelector('.submit-btn').disabled = false;
                    }, 3000);
                } else {
                    throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Apps Script');
                }
            } catch (error) {
                console.error('‚ùå Submit Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                document.querySelector('.submit-btn').disabled = false;

                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 8000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            showPage('patientForm'); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
            document.getElementById('patientForm').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏ß‡∏¢

            document.querySelectorAll('input[name="chronicDisease"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const detail = document.getElementById('chronicDiseaseDetail');
                    if (this.value === '‡∏°‡∏µ') {
                        detail.classList.add('show');
                        document.getElementById('comorbidities').required = true;
                    } else {
                        detail.classList.remove('show');
                        document.getElementById('comorbidities').required = false;
                        document.getElementById('comorbidities').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="medication"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const detail = document.getElementById('medicationDetail');
                    if (this.value === '‡∏°‡∏µ') {
                        detail.classList.add('show');
                        document.getElementById('pre_pregnancy_medications').required = true;
                    } else {
                        detail.classList.remove('show');
                        document.getElementById('pre_pregnancy_medications').required = false;
                        document.getElementById('pre_pregnancy_medications').value = '';
                    }
                });
            });

            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const checked = document.querySelectorAll('.sugar-check:checked');
                    if (checked.length >= 2) { 
                        document.querySelectorAll('.sugar-check:not(:checked)').forEach(cb => cb.disabled = true);
                    } else {
                        document.querySelectorAll('.sugar-check').forEach(cb => cb.disabled = false);
                    }
                });
            });

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('due_date').min = today;

            initializeLiff();
            document.getElementById('patientForm').addEventListener('submit', handleSubmit);

            // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
            document.getElementById('navProfile').addEventListener('click', () => {
                if (currentUserProfile) {
                    populateProfileView(currentUserProfile); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                    showPage('profileViewPage');
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    showPage('patientForm');
                }
            });
            document.getElementById('navFood').addEventListener('click', () => {
                // TODO: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
                showPage('foodHistoryPage');
            });
            document.getElementById('navSugar').addEventListener('click', () => {
                // TODO: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
                showPage('sugarHistoryPage');
            });

            // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                if (currentUserProfile) {
                    populateProfileForm(currentUserProfile); // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    showPage('patientForm'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                }
            });
        });
    </script>
</body>
</html>
