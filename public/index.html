<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h1>
            <p>‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏©‡πå</p>
        </div>
        
        <div class="form-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>
            
            <div id="userStatusSection" style="display: none;">
                <p id="userStatusMessage"></p>
                <button type="button" id="editProfileButton" class="submit-btn" style="display: none;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <form id="patientForm" style="display: none;"> <div class="form-section">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="full_name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="full_name" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô *</label>
                            <input type="text" id="nickname" name="nickname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hospital_id">HN (Hospital Number)</label>
                            <input type="text" id="hospital_id" name="hospital_id">
                        </div>
                        <div class="form-group">
                            <label for="national_id">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                            <input type="text" id="national_id" name="national_id" pattern="[0-9]{13}" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="birth_date">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î *</label>
                            <input type="date" id="birth_date" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label for="height">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.) *</label>
                            <input type="number" id="height" name="height" min="100" max="250" step="0.1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pre_pregnancy_weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏Å‡∏Å.) *</label>
                        <input type="number" id="pre_pregnancy_weight" name="pre_pregnancy_weight" min="30" max="300" step="0.1" required>
                    </div>

                     <div class="form-group">
                        <label for="weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.) *</label>
                        <input type="number" id="weight" name="weight" min="30" max="300" step="0.1" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</h3>
                    <div class="form-group">
                        <label>‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏° (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="comorbidity_dm" name="comorbidities" value="‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå">
                            <label for="comorbidity_dm">‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                            <input type="checkbox" id="comorbidity_ht" name="comorbidities" value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á">
                            <label for="comorbidity_ht">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á</label>
                            <input type="checkbox" id="comorbidity_other" name="comorbidities" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                            <label for="comorbidity_other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                        </div>
                        <input type="text" id="comorbidities_other_detail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                    </div>

                    <div class="form-group">
                        <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)</label>
                        <div class="radio-group">
                            <input type="radio" id="medications_yes" name="pre_pregnancy_medications_choice" value="‡∏°‡∏µ">
                            <label for="medications_yes">‡∏°‡∏µ</label>
                            <input type="radio" id="medications_no" name="pre_pregnancy_medications_choice" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" checked>
                            <label for="medications_no">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                        </div>
                        <div id="medicationsDetail" class="detail-input">
                            <input type="text" id="pre_pregnancy_medications" name="pre_pregnancy_medications" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fetus_count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏ï‡∏£‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå *</label>
                        <input type="number" id="fetus_count" name="fetus_count" min="1" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="due_date">‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì) *</label>
                        <input type="date" id="due_date" name="due_date" required>
                    </div>

                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ß‡∏±‡∏ô)</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sugar_sun" name="sugar_check_days" class="sugar-check" value="‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå">
                            <label for="sugar_sun">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label>
                            <input type="checkbox" id="sugar_mon" name="sugar_check_days" class="sugar-check" value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">
                            <label for="sugar_mon">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label>
                            <input type="checkbox" id="sugar_tue" name="sugar_check_days" class="sugar-check" value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">
                            <label for="sugar_tue">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label>
                            <input type="checkbox" id="sugar_wed" name="sugar_check_days" class="sugar-check" value="‡∏û‡∏∏‡∏ò">
                            <label for="sugar_wed">‡∏û‡∏∏‡∏ò</label>
                            <input type="checkbox" id="sugar_thu" name="sugar_check_days" class="sugar-check" value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">
                            <label for="sugar_thu">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</label>
                            <input type="checkbox" id="sugar_fri" name="sugar_check_days" class="sugar-check" value="‡∏®‡∏∏‡∏Å‡∏£‡πå">
                            <label for="sugar_fri">‡∏®‡∏∏‡∏Å‡∏£‡πå</label>
                            <input type="checkbox" id="sugar_sat" name="sugar_check_days" class="sugar-check" value="‡πÄ‡∏™‡∏≤‡∏£‡πå">
                            <label for="sugar_sat">‡πÄ‡∏™‡∏≤‡∏£‡πå</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï‡∏ï‡πà‡∏≠ 1 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô (‡∏Å‡∏£‡∏±‡∏°/‡∏´‡∏ô‡πà‡∏ß‡∏¢) *</label>
                        <p class="form-description">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Pre-meal Insulin) ‡∏ï‡πà‡∏≠‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="carb_ratio_morning">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤</label>
                                <input type="number" id="carb_ratio_morning" name="carb_ratio_morning" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="carb_ratio_lunch">‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</label>
                                <input type="number" id="carb_ratio_lunch" name="carb_ratio_lunch" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="carb_ratio_dinner">‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô</label>
                                <input type="number" id="carb_ratio_dinner" name="carb_ratio_dinner" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="carb_ratio_bedtime">‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô</label>
                                <input type="number" id="carb_ratio_bedtime" name="carb_ratio_bedtime" step="0.1" required>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitButton">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <div class="loading" id="loadingMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                <div class="success-message" id="successMessage">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
                <div class="error-message" id="errorMessage">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </form>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/sdk/v2/liff.js"></script>
    <script>
        let currentUserId = ''; // ‡πÄ‡∏Å‡πá‡∏ö userId ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å

        // *** ‡πÉ‡∏™‡πà Apps Script Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (URL ‡∏Ç‡∏≠‡∏á Proxy Function) ***
        const appsScriptUrl = 'https://mellifluous-treacle-940f71.netlify.app/.netlify/functions/apps-script-proxy'; 

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('submitButton').disabled = show;
        }

        function showSuccess(show, message = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!') {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = show ? 'block' : 'none';
            if (show) {
                setTimeout(() => successDiv.style.display = 'none', 3000);
            }
        }

        function showError(show, message = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = show ? 'block' : 'none';
            if (show) {
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }
        }

        async function initializeLiff() {
            try {
                // *** ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
                await liff.init({ liffId: '2007493917-XdpdZalP' }); 
                document.getElementById('liffStatus').classList.remove('liff-disconnected');
                document.getElementById('liffStatus').classList.add('liff-connected');
                document.getElementById('liffStatus').textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId;
                    console.log('LIFF initialized, User ID:', currentUserId);
                    checkUserStatus(currentUserId);
                } else {
                    liff.login();
                }

            } catch (err) {
                console.error('LIFF initialization failed', err);
                document.getElementById('liffStatus').classList.add('liff-error');
                document.getElementById('liffStatus').textContent = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE';
                showError(true, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        async function checkUserStatus(userId) {
            try {
                showLoading(true);
                // ‡∏™‡πà‡∏á action=checkUser ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡∏ú‡πà‡∏≤‡∏ô Proxy
                const response = await fetch(`${appsScriptUrl}?action=checkUser&userId=${userId}`);
                const data = await response.json();
                console.log('Check user status response:', data);

                document.getElementById('userStatusSection').style.display = 'block';

                if (data.isRegistered) {
                    document.getElementById('userStatusMessage').textContent = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞';
                    document.getElementById('editProfileButton').style.display = 'block';
                    document.getElementById('patientForm').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    document.getElementById('submitButton').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
                    document.getElementById('editProfileButton').addEventListener('click', async () => {
                        await loadPatientProfile(userId);
                        document.getElementById('userStatusSection').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        document.getElementById('patientForm').style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                    });

                } else {
                    document.getElementById('userStatusMessage').textContent = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    document.getElementById('editProfileButton').style.display = 'none';
                    document.getElementById('patientForm').style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    document.getElementById('submitButton').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; // ‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                }
            } catch (error) {
                console.error('Error checking user status:', error);
                showError(true, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + error.message);
                document.getElementById('userStatusMessage').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                document.getElementById('patientForm').style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            } finally {
                showLoading(false);
            }
        }

        async function loadPatientProfile(userId) {
            try {
                showLoading(true);
                // ‡∏™‡πà‡∏á action=getPatientProfile ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡∏ú‡πà‡∏≤‡∏ô Proxy
                const response = await fetch(`${appsScriptUrl}?action=getPatientProfile&userId=${userId}`);
                const data = await response.json();
                console.log('Load patient profile response:', data);

                if (data.status === 'success' && data.data) {
                    const profile = data.data;
                    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    document.getElementById('full_name').value = profile.full_name || '';
                    document.getElementById('nickname').value = profile.nickname || '';
                    document.getElementById('hospital_id').value = profile.hospital_id || '';
                    document.getElementById('national_id').value = profile.national_id || '';
                    document.getElementById('birth_date').value = profile.birth_date ? new Date(profile.birth_date).toISOString().split('T')[0] : '';
                    document.getElementById('height').value = profile.height || '';
                    document.getElementById('pre_pregnancy_weight').value = profile.pre_pregnancy_weight || '';
                    document.getElementById('weight').value = profile.weight || '';
                    document.getElementById('fetus_count').value = profile.fetus_count || 1;
                    document.getElementById('due_date').value = profile.due_date ? new Date(profile.due_date).toISOString().split('T')[0] : '';

                    // ‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°
                    if (profile.comorbidities) {
                        const comorbiditiesArray = String(profile.comorbidities).split(',').map(s => s.trim());
                        document.querySelectorAll('input[name="comorbidities"]').forEach(cb => {
                            cb.checked = comorbiditiesArray.includes(cb.value);
                            if (cb.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && comorbiditiesArray.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') && comorbiditiesArray[0] !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                                document.getElementById('comorbidities_other_detail').value = profile.comorbidities.replace('‡∏≠‡∏∑‡πà‡∏ô‡πÜ,', '').trim();
                            } else if (cb.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && comorbiditiesArray.length === 1 && comorbiditiesArray[0] === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
                                document.getElementById('comorbidities_other_detail').value = ''; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
                            }
                        });
                        if (document.getElementById('comorbidity_other').checked) {
                            document.getElementById('comorbidities_other_detail').style.display = 'block';
                        } else {
                            document.getElementById('comorbidities_other_detail').style.display = 'none';
                        }
                    }

                    // ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå
                    if (profile.pre_pregnancy_medications) {
                        document.getElementById('medications_yes').checked = true;
                        document.getElementById('pre_pregnancy_medications').value = profile.pre_pregnancy_medications;
                        document.getElementById('medicationsDetail').classList.add('show');
                        document.getElementById('pre_pregnancy_medications').required = true;
                    } else {
                        document.getElementById('medications_no').checked = true;
                        document.getElementById('pre_pregnancy_medications').value = '';
                        document.getElementById('medicationsDetail').classList.remove('show');
                        document.getElementById('pre_pregnancy_medications').required = false;
                    }

                    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
                    if (profile.sugar_check_days) {
                        try {
                            // Apps Script ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Stringified JSON
                            const sugarDays = JSON.parse(profile.sugar_check_days); 
                            document.querySelectorAll('.sugar-check').forEach(cb => {
                                cb.checked = sugarDays.includes(cb.value);
                            });
                            // force disable if more than 3 are checked from saved data
                            if (sugarDays.length >= 3) {
                                document.querySelectorAll('.sugar-check:not(:checked)').forEach(cb => cb.disabled = true);
                            }
                        } catch (e) {
                            console.error('Error parsing sugar_check_days:', e);
                        }
                    }

                    // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô
                    if (profile.carb_ratio) {
                        try {
                            // Apps Script ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Stringified JSON
                            const carbRatio = JSON.parse(profile.carb_ratio); 
                            document.getElementById('carb_ratio_morning').value = carbRatio.morning || '';
                            document.getElementById('carb_ratio_lunch').value = carbRatio.lunch || '';
                            document.getElementById('carb_ratio_dinner').value = carbRatio.dinner || '';
                            document.getElementById('carb_ratio_bedtime').value = carbRatio.bedtime || '';
                        } catch (e) {
                            console.error('Error parsing carb_ratio:', e);
                        }
                    }
                    showSuccess(true, '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    showError(true, '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            } catch (error) {
                console.error('Failed to load patient profile:', error);
                showError(true, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            showLoading(true);
            showError(false); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Å‡πà‡∏≤
            showSuccess(false); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏Å‡πà‡∏≤

            if (!liff.isLoggedIn() || !currentUserId) {
                showError(true, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö User ID');
                showLoading(false);
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            const data = { userId: currentUserId };

            // Collect data from form
            for (let [key, value] of formData.entries()) {
                if (key === 'comorbidities' || key === 'sugar_check_days') {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else if (key === 'pre_pregnancy_medications_choice') {
                    // Do nothing, this is handled by the detail input
                } else if (key.startsWith('carb_ratio_')) {
                    if (!data.carb_ratio) data.carb_ratio = {};
                    data.carb_ratio[key.replace('carb_ratio_', '')] = parseFloat(value);
                } else {
                    data[key] = value;
                }
            }

            // Handle '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' for comorbidities
            const comorbiditiesOtherDetail = document.getElementById('comorbidities_other_detail').value.trim();
            if (data.comorbidities && data.comorbidities.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') && comorbiditiesOtherDetail) {
                 // Remove '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' placeholder if detail is provided and add the detail
                data.comorbidities = data.comorbidities.filter(item => item !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
                data.comorbidities.push(comorbiditiesOtherDetail);
            } else if (data.comorbidities && data.comorbidities.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') && !comorbiditiesOtherDetail) {
                // If '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' is checked but no detail, just keep '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
            }
            if (data.comorbidities) {
                data.comorbidities = data.comorbidities.join(', ');
            }


            // Handle pre_pregnancy_medications
            if (document.getElementById('medications_no').checked) {
                data.pre_pregnancy_medications = ''; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÑ‡∏°‡πà‡∏°‡∏µ' ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏°‡∏µ' ‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≤‡∏Å input field ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

            console.log('Sending data:', data);

            let actionType = document.getElementById('submitButton').textContent === '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? 'addPatient' : 'updatePatientProfile';
            data.action = actionType; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î action ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á

            try {
                // ‡∏™‡πà‡∏á POST request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡∏ú‡πà‡∏≤‡∏ô Proxy
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                console.log('Apps Script response:', result);

                if (result.status === 'success') {
                    showSuccess(true, result.message);
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    if (actionType === 'addPatient') {
                        document.getElementById('userStatusMessage').textContent = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞';
                        document.getElementById('editProfileButton').style.display = 'block';
                        document.getElementById('patientForm').style.display = 'none';
                    }
                    // ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ reload ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
                    await loadPatientProfile(currentUserId); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                } else {
                    showError(true, result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showError(true, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Event listener for comorbidities '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' checkbox
            document.getElementById('comorbidity_other').addEventListener('change', function () {
                const detailInput = document.getElementById('comorbidities_other_detail');
                if (this.checked) {
                    detailInput.style.display = 'block';
                    detailInput.required = true;
                } else {
                    detailInput.style.display = 'none';
                    detailInput.required = false;
                    detailInput.value = ''; // Clear value when unchecked
                }
            });

            // Event listener for medications radio buttons
            document.querySelectorAll('input[name="pre_pregnancy_medications_choice"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const detail = document.getElementById('medicationsDetail');
                    if (this.value === '‡∏°‡∏µ') {
                        detail.classList.add('show');
                        document.getElementById('pre_pregnancy_medications').required = true;
                    } else {
                        detail.classList.remove('show');
                        document.getElementById('pre_pregnancy_medications').required = false;
                        document.getElementById('pre_pregnancy_medications').value = '';
                    }
                });
            });

            // Event listener for sugar check days (max 3 selections)
            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const checked = document.querySelectorAll('.sugar-check:checked');
                    if (checked.length >= 3) {
                        document.querySelectorAll('.sugar-check:not(:checked)').forEach(cb => cb.disabled = true);
                    } else {
                        document.querySelectorAll('.sugar-check').forEach(cb => cb.disabled = false);
                    }
                });
            });

            // Set min date for due_date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('due_date').min = today;

            initializeLiff();
            document.getElementById('patientForm').addEventListener('submit', handleSubmit);
        });
    </script>

</body>
</html>