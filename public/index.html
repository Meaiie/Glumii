<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <style>
        /* CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: sans-serif;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 50%, #e1bee7 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ef78a0, #f897c1);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #f494be;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 2px solid #f8bbd9;
            padding-bottom: 8px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group.full-width {
            flex: 100%;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #f8bbd9;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #f1a1bc;
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .conditional-input {
            margin-top: 10px;
            display: none;
        }
        
        .conditional-input.show {
            display: block;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fce4ec;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .checkbox-item:hover {
            background: #f8bbd9;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .carb-ratio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #f5abc4, #f9b0cf);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto 0;
            box-shadow: 0 4px 15px rgba(232, 131, 165, 0.3);
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(192, 116, 141, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #ec8cac;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .success-message {
            display: none;
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .error-message {
            display: none;
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }
        
        .liff-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .liff-connected {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .liff-disconnected {
            background: #ffebee;
            color: #c62828;
        }
        
        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: auto;
            }
            
            .carb-ratio-group {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h1>
            <p>‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</p>
        </div>
        
        <div class="form-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>
            
            <form id="patientForm">
                <div class="form-section">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="full_name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="full_name" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô *</label>
                            <input type="text" id="nickname" name="nickname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hospital_id">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• *</label>
                            <input type="text" id="hospital_id" name="hospital_id" required>
                        </div>
                        <div class="form-group">
                            <label for="national_id">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô *</label>
                            <input type="text" id="national_id" name="national_id" pattern="[0-9]{13}" maxlength="13" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="birth_date">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î *</label>
                            <input type="date" id="birth_date" name="birth_date" required>
                        </div>
                        <div class="form-group">
                            <label for="height">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.) *</label>
                            <input type="number" id="height" name="height" min="100" max="200" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
                    
                    <div class="form-group full-width">
                        <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß *</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="chronicDiseaseNo" name="chronicDisease" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" required>
                                <label for="chronicDiseaseNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="chronicDiseaseYes" name="chronicDisease" value="‡∏°‡∏µ" required>
                                <label for="chronicDiseaseYes">‡∏°‡∏µ</label>
                            </div>
                        </div>
                        <div class="conditional-input" id="chronicDiseaseDetail">
                            <input type="text" id="comorbidities" name="comorbidities" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå *</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="medicationNo" name="medication" value="‡πÑ‡∏°‡πà‡∏°‡∏µ" required>
                                <label for="medicationNo">‡πÑ‡∏°‡πà‡∏°‡∏µ</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="medicationYes" name="medication" value="‡∏°‡∏µ" required>
                                <label for="medicationYes">‡∏°‡∏µ</label>
                            </div>
                        </div>
                        <div class="conditional-input" id="medicationDetail">
                            <textarea id="pre_pregnancy_medications" name="pre_pregnancy_medications" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pre_pregnancy_weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå (‡∏Å‡∏Å.) *</label>
                            <input type="number" id="pre_pregnancy_weight" name="pre_pregnancy_weight" min="30" max="150" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏Å‡∏Å.) *</label>
                            <input type="number" id="weight" name="weight" min="30" max="150" step="0.1" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fetus_count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏£‡∏†‡πå *</label>
                            <select id="fetus_count" name="fetus_count" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≤‡∏£‡∏Å</option>
                                <option value="1">1 ‡∏Ñ‡∏ô</option>
                                <option value="2">2 ‡∏Ñ‡∏ô</option>
                                <option value="3">3 ‡∏Ñ‡∏ô</option>
                                <option value="4">4 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="due_date">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏•‡∏≠‡∏î *</label>
                            <input type="date" id="due_date" name="due_date" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</h3>
                    
                    <div class="carb-ratio-group">
                        <div class="form-group">
                            <label for="carb_ratio_breakfast">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤ (Breakfast) *</label>
                            <input type="number" id="carb_ratio_breakfast" name="carb_ratio_breakfast" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" required>
                        </div>
                        <div class="form-group">
                            <label for="carb_ratio_lunch">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô (Lunch) *</label>
                            <input type="number" id="carb_ratio_lunch" name="carb_ratio_lunch" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12" required>
                        </div>
                        <div class="form-group">
                            <label for="carb_ratio_dinner">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô (Dinner) *</label>
                            <input type="number" id="carb_ratio_dinner" name="carb_ratio_dinner" step="0.1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="section-title">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏ß‡∏±‡∏ô)</h3>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="monday" class="sugar-check" value="‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå">
                            <label for="monday">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tuesday" class="sugar-check" value="‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£">
                            <label for="tuesday">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wednesday" class="sugar-check" value="‡∏û‡∏∏‡∏ò">
                            <label for="wednesday">‡∏û‡∏∏‡∏ò</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="thursday" class="sugar-check" value="‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ">
                            <label for="thursday">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="friday" class="sugar-check" value="‡∏®‡∏∏‡∏Å‡∏£‡πå">
                            <label for="friday">‡∏®‡∏∏‡∏Å‡∏£‡πå</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="saturday" class="sugar-check" value="‡πÄ‡∏™‡∏≤‡∏£‡πå">
                            <label for="saturday">‡πÄ‡∏™‡∏≤‡∏£‡πå</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sunday" class="sugar-check" value="‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå">
                            <label for="sunday">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" disabled>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                
                <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
                <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </form>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let isLiffReady = false;

        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007439905-GqXEPnq4" }); // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    document.querySelector('.submit-btn').disabled = false;
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();

            if (!isLiffReady) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                return;
            }

            const selectedSugarCheck = Array.from(document.querySelectorAll('.sugar-check:checked')).map(cb => cb.value);
            if (selectedSugarCheck.length !== 3) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏ß‡∏±‡∏ô');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.querySelector('.submit-btn').disabled = true;

            try {
                const profile = await liff.getProfile();
                const userId = profile.userId;

                let comorbidities = '';
                const chronicDiseaseRadio = document.querySelector('input[name="chronicDisease"]:checked');
                if (chronicDiseaseRadio) {
                    comorbidities = chronicDiseaseRadio.value === '‡∏°‡∏µ' ? (document.getElementById('comorbidities').value || '') : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                } else {
                    comorbidities = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
                }

                let prePregMedications = '';
                const medicationRadio = document.querySelector('input[name="medication"]:checked');
                if (medicationRadio) {
                    prePregMedications = medicationRadio.value === '‡∏°‡∏µ' ? (document.getElementById('pre_pregnancy_medications').value || '') : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                } else {
                    prePregMedications = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
                }

                const formData = {
                    userId,
                    full_name: document.getElementById('full_name').value || '',
                    nickname: document.getElementById('nickname').value || '',
                    hospital_id: document.getElementById('hospital_id').value || '',
                    national_id: document.getElementById('national_id').value || '',
                    birth_date: document.getElementById('birth_date').value || '',
                    comorbidities,
                    pre_pregnancy_medications: prePregMedications,
                    pre_pregnancy_weight: parseFloat(document.getElementById('pre_pregnancy_weight').value) || 0,
                    weight: parseFloat(document.getElementById('weight').value) || 0,
                    height: parseFloat(document.getElementById('height').value) || 0,
                    fetus_count: parseInt(document.getElementById('fetus_count').value) || 0,
                    due_date: document.getElementById('due_date').value || '',
                    carb_ratio: {
                        breakfast: parseFloat(document.getElementById('carb_ratio_breakfast').value) || 0,
                        lunch: parseFloat(document.getElementById('carb_ratio_lunch').value) || 0,
                        dinner: parseFloat(document.getElementById('carb_ratio_dinner').value) || 0
                    },
                    sugar_check_days: selectedSugarCheck
                };

                console.log('Sending data:', JSON.stringify(formData, null, 2));

                // **** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Netlify Function ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ****
                const url = '/.netlify/functions/apps-script-proxy'; 
                console.log('Attempting to fetch to Netlify Function:', url);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorDetails = await response.text(); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å server
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Server response from Netlify Function:', result);

                if (result.status === 'success') {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');

                    setTimeout(() => {
                        document.getElementById('patientForm').reset();
                        document.getElementById('successMessage').style.display = 'none';
                        document.querySelector('.submit-btn').disabled = false;
                        document.querySelectorAll('.sugar-check').forEach(cb => cb.disabled = false);
                        document.getElementById('chronicDiseaseDetail').classList.remove('show');
                        document.getElementById('medicationDetail').classList.remove('show');
                        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ window.history.replaceState ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å redirect ‡∏Ç‡∏≠‡∏á Apps Script ‡πÅ‡∏•‡πâ‡∏ß
                    }, 3000);
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà Apps Script ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏ï‡πà HTTP status ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô 200
                    throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Apps Script');
                }
            } catch (error) {
                console.error('‚ùå Submit Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                document.querySelector('.submit-btn').disabled = false;

                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ window.history.replaceState ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
                }, 8000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ redirect ‡∏à‡∏≤‡∏Å Apps Script ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Netlify Function ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß
            // const urlParams = new URLSearchParams(window.location.search);
            // const status = urlParams.get('status');
            // const message = urlParams.get('message');
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ) ...

            document.querySelectorAll('input[name="chronicDisease"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const detail = document.getElementById('chronicDiseaseDetail');
                    if (this.value === '‡∏°‡∏µ') {
                        detail.classList.add('show');
                        document.getElementById('comorbidities').required = true;
                    } else {
                        detail.classList.remove('show');
                        document.getElementById('comorbidities').required = false;
                        document.getElementById('comorbidities').value = '';
                    }
                });
            });

            document.querySelectorAll('input[name="medication"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const detail = document.getElementById('medicationDetail');
                    if (this.value === '‡∏°‡∏µ') {
                        detail.classList.add('show');
                        document.getElementById('pre_pregnancy_medications').required = true;
                    } else {
                        detail.classList.remove('show');
                        document.getElementById('pre_pregnancy_medications').required = false;
                        document.getElementById('pre_pregnancy_medications').value = '';
                    }
                });
            });

            document.querySelectorAll('.sugar-check').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const checked = document.querySelectorAll('.sugar-check:checked');
                    if (checked.length >= 3) {
                        document.querySelectorAll('.sugar-check:not(:checked)').forEach(cb => cb.disabled = true);
                    } else {
                        document.querySelectorAll('.sugar-check').forEach(cb => cb.disabled = false);
                    }
                });
            });

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('due_date').min = today;

            initializeLiff();
            // ‡∏•‡∏ö debugTest() ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            // debugTest(); 

            document.getElementById('patientForm').addEventListener('submit', handleSubmit);
        });
    </script>

</body>
</html>