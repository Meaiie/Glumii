<!DOCTYPE html>
<html lang="th">
<head>
┬а ┬а <meta charset="UTF-8">
┬а ┬а <meta name="viewport" content="width=device-width, initial-scale=1.0">
┬а ┬а <title>р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕е - р╕гр╕░р╕Ър╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕Щр╣Др╕Вр╣Йр╕кр╕Хр╕гр╕╡р╕Хр╕▒р╣Йр╕Зр╕Др╕гр╕гр╕ар╣М</title>
    <link rel="stylesheet" href="style.css">
┬а ┬а <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
┬а ┬а <div class="container">
┬а ┬а ┬а ┬а <div class="header">
┬а ┬а ┬а ┬а ┬а ┬а <h1><i class="fas fa-tint"></i> р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕░р╕Фр╕▒р╕Ър╕Щр╣Йр╕│р╕Хр╕▓р╕е <span>р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Др╕╕р╕Ур╣Бр╕бр╣Ир╕Хр╕▒р╣Йр╕Зр╕Др╕гр╕гр╕ар╣М</span></h1>
┬а ┬а ┬а ┬а ┬а ┬а <div class="user-info">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а р╕кр╕зр╕▒р╕кр╕Фр╕╡, <span id="liffDisplayName">р╕Др╕╕р╕Ур╣Бр╕бр╣И</span> <span>ЁЯСйтАНЁЯж░</span>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а <div class="nav-tabs">
┬а ┬а ┬а ┬а ┬а ┬а <a href="#" class="nav-tab" id="profileTab">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-user-alt"></i> р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕кр╣Ир╕зр╕Щр╕Хр╕▒р╕з
┬а ┬а ┬а ┬а ┬а ┬а </a>
┬а ┬а ┬а ┬а ┬а ┬а <a href="#" class="nav-tab" id="foodRecordsTab">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-utensils"></i> р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕нр╕▓р╕лр╕▓р╕г
┬а ┬а ┬а ┬а ┬а ┬а </a>
┬а ┬а ┬а ┬а ┬а ┬а <a href="#" class="nav-tab active" id="sugarRecordsTab">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <i class="fas fa-tint"></i> р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕е
┬а ┬а ┬а ┬а ┬а ┬а </a>
┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а <div class="record-container">
┬а ┬а ┬а ┬а ┬а ┬а <div id="liffStatus" class="liff-status liff-disconnected">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ЁЯФД р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н LINE...
┬а ┬а ┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а ┬а ┬а <div class="record-form-section">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="section-header">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h3 class="section-title">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕░р╕Фр╕▒р╕Ър╕Щр╣Йр╕│р╕Хр╕▓р╕ер╣Гр╕Щр╣Ар╕ер╕╖р╕нр╕Ф</h3>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <form id="sugarRecordForm">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="hidden" id="editingRecordId" value=""> 
                    <div class="form-grid">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="form-group">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="recordDate">р╕зр╕▒р╕Щр╕Чр╕╡р╣И:</label>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="date" id="recordDate" name="record_date" required>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="form-group">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="recordTime">р╣Ар╕зр╕ер╕▓:</label>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="time" id="recordTime" name="record_time" required>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="form-group">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="pbsValue">р╕Др╣Ир╕▓ PBS (mg/dL):</label>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="number" id="pbsValue" name="pbs_value" step="0.1" min="0" required>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="form-group">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="sugarFlag">р╕кр╕Цр╕▓р╕Щр╕░:</label>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <select id="sugarFlag" name="sugar_flag" required>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="">р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕Цр╕▓р╕Щр╕░</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="р╕Ыр╕Бр╕Хр╕┤">р╕Ыр╕Бр╕Хр╕┤</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="р╕Ьр╕┤р╕Фр╕Ыр╕Бр╕Хр╕┤">р╕Ьр╕┤р╕Фр╕Ыр╕Бр╕Хр╕┤</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </select>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="button-group form-btns">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button type="button" id="cancelEditBtn" class="cancel-btn" style="display: none;">р╕вр╕Бр╣Ар╕ер╕┤р╕Б</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button type="submit" id="saveSugarRecordBtn" class="save-btn">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╣Йр╕│р╕Хр╕▓р╕е</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </form>

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="loading" id="loading">тП│ р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г...</div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="success-message" id="successMessage">тЬЕ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з!</div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="error-message" id="errorMessage">тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З</div>
┬а ┬а ┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а ┬а ┬а <div class="records-display-section">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="section-header">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h3 class="section-title">р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕е</h3>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="records-table-wrapper">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <table id="sugarRecordsTable">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <thead>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <tr>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <th>р╕зр╕▒р╕Щр╕Чр╕╡р╣И</th>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <th>р╣Ар╕зр╕ер╕▓</th>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <th>р╕Др╣Ир╕▓ PBS (mg/dL)</th>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <th>р╕кр╕Цр╕▓р╕Щр╕░</th>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <th>р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г</th>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </tr>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </thead>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <tbody id="sugarRecordsTableBody">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </tbody>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </table>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а </div>

┬а ┬а <div class="modal-overlay" id="confirmationModal">
┬а ┬а ┬а ┬а <div class="modal-content">
┬а ┬а ┬а ┬а ┬а ┬а <p>р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г</p>
┬а ┬а ┬а ┬а ┬а ┬а <p>р╕Др╕╕р╕Ур╣Бр╕Щр╣Ир╣Гр╕Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕зр╣Ир╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕╡р╣Й?</p>
┬а ┬а ┬а ┬а ┬а ┬а <div class="modal-actions">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button class="cancel-btn" id="modalCancelBtn">р╕вр╕Бр╣Ар╕ер╕┤р╕Б</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button class="confirm-btn" id="modalConfirmBtn">р╕вр╕╖р╕Щр╕вр╕▒р╕Щ</button>
┬а ┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а </div>

┬а ┬а <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
┬а ┬а <script>
┬а ┬а ┬а ┬а // LIFF Config
┬а ┬а ┬а ┬а let isLiffReady = false;
┬а ┬а ┬а ┬а let liffUserId = null;
┬а ┬а ┬а ┬а let userDisplayName = 'р╕Др╕╕р╕Ур╣Бр╕бр╣И';
┬а ┬а ┬а ┬а // URL р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Й Netlify Function р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ Proxy р╣Др╕Ыр╕вр╕▒р╕З Apps Script
┬а ┬а ┬а ┬а const appsScriptUrl = '/.netlify/functions/apps-script-proxy'; 
┬а ┬а ┬а ┬а let currentRecords = []; // р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╕Фр╕╢р╕Зр╕бр╕▓

┬а ┬а ┬а ┬а // --- Helper Functions ---
┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а /**
┬а ┬а ┬а ┬а * р╣Бр╕Ыр╕ер╕З ISO String р╣Ар╕Ыр╣Зр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕Ьр╕е
┬а ┬а ┬а ┬а * @param {string} isoString - ISO Date String (e.g., YYYY-MM-DDTHH:MM:SS.SSSZ)
┬а ┬а ┬а ┬а */
┬а ┬а ┬а ┬а function formatDate(isoString) {
┬а ┬а ┬а ┬а ┬а ┬а if (!isoString) return 'N/A';
┬а ┬а ┬а ┬а ┬а ┬а const date = new Date(isoString);
┬а ┬а ┬а ┬а ┬а ┬а // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
┬а ┬а ┬а ┬а ┬а ┬а if (isNaN(date.getTime())) return 'р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З';
┬а ┬а ┬а ┬а ┬а ┬а return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а /**
┬а ┬а ┬а ┬а * р╣Бр╕Ыр╕ер╕З ISO String р╣Ар╕Ыр╣Зр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╣Ар╕зр╕ер╕▓ (HH:MM) р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕Ьр╕е
┬а ┬а ┬а ┬а * @param {string} isoString - ISO Date String (e.g., YYYY-MM-DDTHH:MM:SS.SSSZ)
┬а ┬а ┬а ┬а */
┬а ┬а ┬а ┬а function formatTime(isoString) {
┬а ┬а ┬а ┬а ┬а ┬а if (!isoString) return 'N/A';
┬а ┬а ┬а ┬а ┬а ┬а const date = new Date(isoString);
┬а ┬а ┬а ┬а ┬а ┬а // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
┬а ┬а ┬а ┬а ┬а ┬а if (isNaN(date.getTime())) return 'р╣Ар╕зр╕ер╕▓р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З';
┬а ┬а ┬а ┬а ┬а ┬а return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function displayMessage(type, message) {
┬а ┬а ┬а ┬а ┬а ┬а // р╕Лр╣Ир╕нр╕Щр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('loading').style.display = 'none';
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('successMessage').style.display = 'none';
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('errorMessage').style.display = 'none';

┬а ┬а ┬а ┬а ┬а ┬а // р╣Бр╕кр╕Фр╕Зр╣Ар╕Йр╕Юр╕▓р╕░р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
┬а ┬а ┬а ┬а ┬а ┬а const targetElement = document.getElementById(type + 'Message');
┬а ┬а ┬а ┬а ┬а ┬а if (targetElement) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а targetElement.innerHTML = (type === 'error' ? 'тЭМ ' : 'тЬЕ ') + message;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а targetElement.style.display = 'block';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (type !== 'loading') {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а setTimeout(() => targetElement.style.display = 'none', 5000);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }


┬а ┬а ┬а ┬а // --- LIFF Initialization ---

┬а ┬а ┬а ┬а async function initializeLiff() {
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // IMPORTANT: р╣Гр╕Кр╣Й LIFF ID р╕Вр╕нр╕Зр╕Др╕╕р╕У
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await liff.init({ liffId: "2007493917-XdpdZalP" }); 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!liff.isLoggedIn()) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а liff.login();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а } else {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а isLiffReady = true;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('liffStatus').className = 'liff-status liff-connected';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('liffStatus').innerHTML = 'тЬЕ р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н LINE р╕кр╕│р╣Ар╕гр╣Зр╕И';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const profile = await liff.getProfile();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а liffUserId = profile.userId;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а userDisplayName = profile.displayName || 'р╕Др╕╕р╕Ур╣Бр╕бр╣И';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('liffDisplayName').innerText = userDisplayName;

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await fetchSugarRecords(liffUserId);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а } catch (error) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('LIFF initialization failed:', error);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('liffStatus').innerHTML = 'тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н LINE р╣Др╕Фр╣Й';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- Fetch Records ---

┬а ┬а ┬а ┬а async function fetchSugarRecords(userId) {
┬а ┬а ┬а ┬а ┬а ┬а console.log('Fetching sugar records for userId:', userId);
┬а ┬а ┬а ┬а ┬а ┬а const recordsTableBody = document.getElementById('sugarRecordsTableBody');
┬а ┬а ┬а ┬а ┬а ┬а recordsTableBody.innerHTML = '<tr><td colspan="5" class="loading">ЁЯФД р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕е...</td></tr>';

┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╣Гр╕Кр╣Й Netlify Function Proxy р╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б Apps Script
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const response = await fetch(appsScriptUrl, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а headers: { 'Content-Type': 'application/json' },
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify({ action: 'getSugarRecords', userId: userId })
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!response.ok) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const errorDetails = await response.text();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const result = await response.json();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.log('Sugar records data from Netlify Function:', result);

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а recordsTableBody.innerHTML = ''; // р╕ер╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Фр╕┤р╕б

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (result.status === 'success' && result.records && result.records.length > 0) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а currentRecords = result.records; // р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Фр╕╢р╕Зр╕бр╕▓
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а result.records.forEach(record => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const tr = document.createElement('tr');
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Бр╕ер╕░р╕Бр╕│р╕лр╕Щр╕Ф class р╕Хр╕▓р╕бр╕кр╕Цр╕▓р╕Щр╕░р╕Щр╣Йр╕│р╕Хр╕▓р╕е
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const statusClass = record.sugarFlag === 'р╕Ыр╕Бр╕Хр╕┤' ? 'sugar-flag-normal' : 'sugar-flag-abnormal';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а tr.innerHTML = `
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <td>${formatDate(record.datetime)}</td>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <td>${formatTime(record.datetime)}</td>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <td>${(record.pbs || 'N/A')}</td>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <td><span class="${statusClass}">${record.sugarFlag || 'N/A'}</span></td>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <td class="actions-cell">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button type="button" class="icon-btn edit-record-btn" onclick="editSugarRecord('${record.recordId}')"><i class="fas fa-edit"></i></button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button type="button" class="icon-btn delete-record-btn" onclick="showDeleteConfirmation('${record.recordId}')"><i class="fas fa-trash-alt"></i></button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </td>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а `;
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а recordsTableBody.appendChild(tr);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а } else {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б 'р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е'
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а recordsTableBody.innerHTML = '<tr><td colspan="5" class="no-data-message">р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕е</td></tr>';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а } catch (error) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('Error fetching sugar records:', error);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а recordsTableBody.innerHTML = '<tr><td colspan="5" class="error-message">тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Щр╣Йр╕│р╕Хр╕▓р╕ер╣Др╕Фр╣Й</td></tr>';
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- Save / Update Record ---

┬а ┬а ┬а ┬а async function handleSaveSugarRecord(event) {
┬а ┬а ┬а ┬а ┬а ┬а event.preventDefault();

┬а ┬а ┬а ┬а ┬а ┬а if (!isLiffReady || !liffUserId) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕нр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н LIFF р╣Гр╕лр╣Йр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М');
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а const form = event.target;
┬а ┬а ┬а ┬а ┬а ┬а if (!form.checkValidity()) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а form.reportValidity();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╣Йр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щр╣Бр╕ер╕░р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З');
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а displayMessage('loading', 'р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е...');

┬а ┬а ┬а ┬а ┬а ┬а const recordDate = document.getElementById('recordDate').value;
┬а ┬а ┬а ┬а ┬а ┬а const recordTime = document.getElementById('recordTime').value;
┬а ┬а ┬а ┬а ┬а ┬а const pbsValue = document.getElementById('pbsValue').value;
┬а ┬а ┬а ┬а ┬а ┬а const sugarFlag = document.getElementById('sugarFlag').value;
┬а ┬а ┬а ┬а ┬а ┬а const editingRecordId = document.getElementById('editingRecordId').value;
┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а const action = editingRecordId ? 'updateSugarRecord' : 'addSugarRecord';
┬а ┬а ┬а ┬а ┬а ┬а // р╕гр╕зр╕бр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ YYYY-MM-DDTHH:MM:00 р╕Лр╕╢р╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щ ISO 8601 string р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
┬а ┬а ┬а ┬а ┬а ┬а const dateTimeCombined = `${recordDate}T${recordTime}:00`; 

┬а ┬а ┬а ┬а ┬а ┬а const data = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а action: action,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а userId: liffUserId,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а datetime: dateTimeCombined,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а pbs: parseFloat(pbsValue),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а sugarFlag: sugarFlag,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ...(editingRecordId && { recordId: editingRecordId }) // р╣Ар╕Юр╕┤р╣Ир╕б recordId р╣Гр╕Щр╣Вр╕лр╕бр╕Ф update
┬а ┬а ┬а ┬а ┬а ┬а };

┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const response = await fetch(appsScriptUrl, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а headers: { 'Content-Type': 'application/json' },
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify(data)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!response.ok) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const errorDetails = await response.text();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const result = await response.json();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('loading', '');

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (result.status === 'success') {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('success', `${action === 'updateSugarRecord' ? 'р╣Бр╕Бр╣Йр╣Др╕В' : 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б'} р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з!`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а form.reset(); 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('editingRecordId').value = '';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('saveSugarRecordBtn').innerText = 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╣Йр╕│р╕Хр╕▓р╕е';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('cancelEditBtn').style.display = 'none';
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await fetchSugarRecords(liffUserId); 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а } else {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', `р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: ${result.message || 'р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╣Др╕Фр╣Й'}`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а } catch (error) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('Error saving/updating sugar record:', error);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', `р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н: ${error.message}`);
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- Edit Record ---

┬а ┬а ┬а ┬а function editSugarRecord(recordId) {
┬а ┬а ┬а ┬а ┬а ┬а const record = currentRecords.find(r => r.recordId === recordId);
┬а ┬а ┬а ┬а ┬а ┬а if (!record) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('Record not found for editing:', recordId);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а // *** р╣Бр╕Бр╣Йр╣Др╕Вр╕кр╣Ир╕зр╕Щр╕Щр╕╡р╣Йр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕Кр╣Й Date Object р╣Гр╕Щр╕Бр╕▓р╕гр╣Бр╕вр╕Б р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕кр╕│р╕лр╕гр╕▒р╕Ъ Input ***
┬а ┬а ┬а ┬а ┬а ┬а const dateObj = new Date(record.datetime);

┬а ┬а ┬а ┬а ┬а ┬а if (isNaN(dateObj.getTime())) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('Cannot parse datetime string for editing:', record.datetime);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', 'р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╣Ир╕▓р╕Щр╕Др╣Ир╕▓р╕зр╕▒р╕Щр╕Чр╕╡р╣И/р╣Ар╕зр╕ер╕▓р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╣Др╕Фр╣Й');
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а // 1. Date part (YYYY-MM-DD) - р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Щр╕╡р╣Йр╣Ар╕Ыр╣Кр╕░р╣Ж р╕кр╕│р╕лр╕гр╕▒р╕Ъ input type="date"
┬а ┬а ┬а ┬а ┬а ┬а const year = dateObj.getFullYear();
┬а ┬а ┬а ┬а ┬а ┬а const month = String(dateObj.getMonth() + 1).padStart(2, '0');
┬а ┬а ┬а ┬а ┬а ┬а const day = String(dateObj.getDate()).padStart(2, '0');
┬а ┬а ┬а ┬а ┬а ┬а const datePart = `${year}-${month}-${day}`;

┬а ┬а ┬а ┬а ┬а ┬а // 2. Time part (HH:MM) - р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ 24 р╕Кр╕б. р╕кр╕│р╕лр╕гр╕▒р╕Ъ input type="time"
┬а ┬а ┬а ┬а ┬а ┬а const hours = String(dateObj.getHours()).padStart(2, '0');
┬а ┬а ┬а ┬а ┬а ┬а const minutes = String(dateObj.getMinutes()).padStart(2, '0');
┬а ┬а ┬а ┬а ┬а ┬а const timePart = `${hours}:${minutes}`;

┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('editingRecordId').value = record.recordId;
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('recordDate').value = datePart; // р╕Бр╕│р╕лр╕Щр╕Фр╕Др╣Ир╕▓ YYYY-MM-DD
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('recordTime').value = timePart; // р╕Бр╕│р╕лр╕Щр╕Фр╕Др╣Ир╕▓ HH:MM
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('pbsValue').value = record.pbs;
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('sugarFlag').value = record.sugarFlag;

┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('saveSugarRecordBtn').innerText = 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В';
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('cancelEditBtn').style.display = 'inline-block';
┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а // р╣Ар╕ер╕╖р╣Ир╕нр╕Щр╕лр╕Щр╣Йр╕▓р╕Ир╕нр╣Др╕Ыр╕Чр╕╡р╣Ир╕Яр╕нр╕гр╣Мр╕б
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('sugarRecordForm').scrollIntoView({ behavior: 'smooth' });
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function cancelEdit() {
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('sugarRecordForm').reset();
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('editingRecordId').value = '';
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('saveSugarRecordBtn').innerText = 'р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╣Йр╕│р╕Хр╕▓р╕е';
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('cancelEditBtn').style.display = 'none';
┬а ┬а ┬а ┬а ┬а ┬а // Set default date to today after reset
┬а ┬а ┬а ┬а ┬а ┬а const today = new Date().toISOString().split('T')[0];
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('recordDate').value = today;
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а // --- Delete Record (Confirmation Modal) ---

┬а ┬а ┬а ┬а let recordIdToDelete = null;

┬а ┬а ┬а ┬а function showDeleteConfirmation(recordId) {
┬а ┬а ┬а ┬а ┬а ┬а recordIdToDelete = recordId;
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('confirmationModal').classList.add('active');
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а async function confirmDelete() {
┬а ┬а ┬а ┬а ┬а ┬а if (!recordIdToDelete || !liffUserId) return;

┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('confirmationModal').classList.remove('active');
┬а ┬а ┬а ┬а ┬а ┬а displayMessage('loading', 'р╕Бр╕│р╕ер╕▒р╕Зр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е...');
┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╣Гр╕Кр╣Й Netlify Function Proxy р╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б Apps Script
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const response = await fetch(appsScriptUrl, {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а method: 'POST',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а headers: { 'Content-Type': 'application/json' },
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а body: JSON.stringify({ action: 'deleteSugarRecord', userId: liffUserId, recordId: recordIdToDelete })
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (!response.ok) throw new Error('Failed to delete record from server.');

┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а const result = await response.json();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (result.status === 'success') {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('success', 'р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з!');
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а await fetchSugarRecords(liffUserId); // Refresh list
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а } else {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', `р╕ер╕Ър╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И: ${result.message || 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕ер╕Ъ'}`);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а ┬а } catch (error) {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а console.error('Error deleting record:', error);
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а displayMessage('error', `р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕ер╕Ъ: ${error.message}`);
┬а ┬а ┬а ┬а ┬а ┬а } finally {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а recordIdToDelete = null;
┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а function cancelDelete() {
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('confirmationModal').classList.remove('active');
┬а ┬а ┬а ┬а ┬а ┬а recordIdToDelete = null;
┬а ┬а ┬а ┬а }


┬а ┬а ┬а ┬а // --- Event Listeners ---

┬а ┬а ┬а ┬а document.addEventListener('DOMContentLoaded', () => {
┬а ┬а ┬а ┬а ┬а ┬а initializeLiff();

┬а ┬а ┬а ┬а ┬а ┬а // Set default date to today
┬а ┬а ┬а ┬а ┬а ┬а const today = new Date().toISOString().split('T')[0];
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('recordDate').value = today;

┬а ┬а ┬а ┬а ┬а ┬а // Form submission
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('sugarRecordForm').addEventListener('submit', handleSaveSugarRecord);
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

┬а ┬а ┬а ┬а ┬а ┬а // Modal listeners
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('modalConfirmBtn').addEventListener('click', confirmDelete);
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('modalCancelBtn').addEventListener('click', cancelDelete);
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('confirmationModal').addEventListener('click', (e) => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if (e.target.id === 'confirmationModal') cancelDelete();
┬а ┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а ┬а // Navigation tab listeners (Same as before)
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('profileTab').addEventListener('click', (e) => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а e.preventDefault();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕кр╕бр╕бр╕Хр╕┤р╕зр╣Ир╕▓р╣Др╕Яр╕ер╣М profile.html р╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а window.location.href = `${window.location.origin}/profile.html`;
┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а ┬а ┬а document.getElementById('foodRecordsTab').addEventListener('click', (e) => {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а e.preventDefault();
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а // р╕кр╕бр╕бр╕Хр╕┤р╕зр╣Ир╕▓р╣Др╕Яр╕ер╣М food_records.html р╕нр╕вр╕╣р╣Ир╣Гр╕Щ path р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а window.location.href = `${window.location.origin}/food_records.html`;
┬а ┬а ┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а ┬а ┬а // sugarRecordsTab р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕Чр╕│р╕нр╕░р╣Др╕г р╣Ар╕Юр╕гр╕▓р╕░р╣Ар╕гр╕▓р╕нр╕вр╕╣р╣Ир╕Чр╕╡р╣Ир╕лр╕Щр╣Йр╕▓р╕Щр╕╡р╣Йр╣Бр╕ер╣Йр╕з
┬а ┬а ┬а ┬а });
┬а ┬а </script>
</body>
</html>