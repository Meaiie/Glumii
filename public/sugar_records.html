<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tint"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• <span>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span></h1>
            <div class="user-info">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="liffDisplayName">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà</span> <span>üë©‚Äçü¶∞</span>
            </div>
        </div>
        
        <div class="nav-tabs">
            <a href="#" class="nav-tab" id="profileTab">
                <i class="fas fa-user-alt"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </a>
            <a href="#" class="nav-tab" id="foodRecordsTab">
                <i class="fas fa-utensils"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </a>
            <a href="#" class="nav-tab active" id="sugarRecordsTab">
                <i class="fas fa-tint"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
            </a>
        </div>

        <div class="record-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>

            <div class="record-form-section">
                <div class="section-header">
                    <h3 class="section-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h3>
                </div>
                
                <form id="sugarRecordForm">
                    <input type="hidden" id="editingRecordId" value=""> <div class="form-grid">
                        <div class="form-group">
                            <label for="recordDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                            <input type="date" id="recordDate" name="record_date" required>
                        </div>
                        <div class="form-group">
                            <label for="recordTime">‡πÄ‡∏ß‡∏•‡∏≤:</label>
                            <input type="time" id="recordTime" name="record_time" required>
                        </div>
                        <div class="form-group">
                            <label for="pbsValue">‡∏Ñ‡πà‡∏≤ PBS (mg/dL):</label>
                            <input type="number" id="pbsValue" name="pbs_value" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="sugarFlag">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                            <select id="sugarFlag" name="sugar_flag" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group form-btns">
                        <button type="button" id="cancelEditBtn" class="cancel-btn" style="display: none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" id="saveSugarRecordBtn" class="save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</button>
                    </div>
                </form>

                <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
                <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
                <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>

            <div class="records-display-section">
                <div class="section-header">
                    <h3 class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</h3>
                </div>
                <div class="records-table-wrapper">
                    <table id="sugarRecordsTable">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡∏Ñ‡πà‡∏≤ PBS (mg/dL)</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="sugarRecordsTableBody">
                            </tbody>
                    </table>
                    </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <p>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?</p>
            <div class="modal-actions">
                <button class="cancel-btn" id="modalCancelBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="confirm-btn" id="modalConfirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // LIFF Config
        let isLiffReady = false;
        let liffUserId = null;
        let userDisplayName = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà';
        const appsScriptUrl = '/.netlify/functions/apps-script-proxy'; 
        let currentRecords = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤

        // --- Helper Functions ---
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function displayMessage(type, message) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const targetElement = document.getElementById(type + 'Message');
            if (targetElement) {
                targetElement.innerHTML = (type === 'error' ? '‚ùå ' : '‚úÖ ') + message;
                targetElement.style.display = 'block';
                if (type !== 'loading') {
                    setTimeout(() => targetElement.style.display = 'none', 5000);
                }
            }
        }


        // --- LIFF Initialization ---

        async function initializeLiff() {
            try {
                // IMPORTANT: ‡πÉ‡∏ä‡πâ LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                await liff.init({ liffId: "2007493917-XdpdZalP" }); 
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    
                    const profile = await liff.getProfile();
                    liffUserId = profile.userId;
                    userDisplayName = profile.displayName || '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà';
                    document.getElementById('liffDisplayName').innerText = userDisplayName;

                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    await fetchSugarRecords(liffUserId);
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
            }
        }

        // --- Fetch Records ---

        async function fetchSugarRecords(userId) {
            console.log('Fetching sugar records for userId:', userId);
            const recordsTableBody = document.getElementById('sugarRecordsTableBody');
            recordsTableBody.innerHTML = '<tr><td colspan="5" class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•...</td></tr>';

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getSugarRecords', userId: userId })
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Sugar records data from Netlify Function:', result);

                recordsTableBody.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°

                if (result.status === 'success' && result.records && result.records.length > 0) {
                    currentRecords = result.records; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    result.records.forEach(record => {
                        const tr = document.createElement('tr');
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î class ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
                        const statusClass = record.sugarFlag === '‡∏õ‡∏Å‡∏ï‡∏¥' ? 'sugar-flag-normal' : 'sugar-flag-abnormal';
                        
                        tr.innerHTML = `
                            <td>${formatDate(record.datetime)}</td>
                            <td>${formatTime(record.datetime)}</td>
                            <td>${(record.pbs || 'N/A')}</td>
                            <td><span class="${statusClass}">${record.sugarFlag || 'N/A'}</span></td>
                            <td class="actions-cell">
                                <button type="button" class="icon-btn edit-record-btn" onclick="editSugarRecord('${record.recordId}')"><i class="fas fa-edit"></i></button>
                                <button type="button" class="icon-btn delete-record-btn" onclick="showDeleteConfirmation('${record.recordId}')"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        `;
                        recordsTableBody.appendChild(tr);
                    });
                } else {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                    recordsTableBody.innerHTML = '<tr><td colspan="5" class="no-data-message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</td></tr>';
                }

            } catch (error) {
                console.error('Error fetching sugar records:', error);
                recordsTableBody.innerHTML = '<tr><td colspan="5" class="error-message">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏î‡πâ</td></tr>';
            }
        }

        // --- Save / Update Record ---

        async function handleSaveSugarRecord(event) {
            event.preventDefault();

            if (!isLiffReady || !liffUserId) {
                displayMessage('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
                return;
            }

            const form = event.target;
            if (!form.checkValidity()) {
                form.reportValidity();
                displayMessage('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            displayMessage('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            const recordDate = document.getElementById('recordDate').value;
            const recordTime = document.getElementById('recordTime').value;
            const pbsValue = document.getElementById('pbsValue').value;
            const sugarFlag = document.getElementById('sugarFlag').value;
            const editingRecordId = document.getElementById('editingRecordId').value;
            
            const action = editingRecordId ? 'updateSugarRecord' : 'addSugarRecord';
            const dateTimeCombined = `${recordDate}T${recordTime}:00`; 

            const data = {
                action: action,
                userId: liffUserId,
                datetime: dateTimeCombined,
                pbs: parseFloat(pbsValue),
                sugarFlag: sugarFlag,
                ...(editingRecordId && { recordId: editingRecordId }) // ‡πÄ‡∏û‡∏¥‡πà‡∏° recordId ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î update
            };

            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                displayMessage('loading', '');

                if (result.status === 'success') {
                    displayMessage('success', `${action === 'updateSugarRecord' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
                    form.reset(); 
                    document.getElementById('editingRecordId').value = '';
                    document.getElementById('saveSugarRecordBtn').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•';
                    document.getElementById('cancelEditBtn').style.display = 'none';
                    await fetchSugarRecords(liffUserId); 
                } else {
                    displayMessage('error', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'}`);
                }

            } catch (error) {
                console.error('Error saving/updating sugar record:', error);
                displayMessage('error', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.message}`);
            }
        }

        // --- Edit Record ---

        function editSugarRecord(recordId) {
            const record = currentRecords.find(r => r.recordId === recordId);
            if (!record) {
                console.error('Record not found for editing:', recordId);
                return;
            }

            // ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ISO String (YYYY-MM-DDTHH:MM:SS)
            const parts = record.datetime.split('T');
            const datePart = parts[0];
            const timePart = parts[1] ? parts[1].substring(0, 5) : ''; // ‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ HH:MM

            document.getElementById('editingRecordId').value = record.recordId;
            document.getElementById('recordDate').value = datePart;
            document.getElementById('recordTime').value = timePart;
            document.getElementById('pbsValue').value = record.pbs;
            document.getElementById('sugarFlag').value = record.sugarFlag;

            document.getElementById('saveSugarRecordBtn').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('sugarRecordForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('sugarRecordForm').reset();
            document.getElementById('editingRecordId').value = '';
            document.getElementById('saveSugarRecordBtn').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // --- Delete Record (Confirmation Modal) ---

        let recordIdToDelete = null;

        function showDeleteConfirmation(recordId) {
            recordIdToDelete = recordId;
            document.getElementById('confirmationModal').classList.add('active');
        }

        async function confirmDelete() {
            if (!recordIdToDelete || !liffUserId) return;

            document.getElementById('confirmationModal').classList.remove('active');
            displayMessage('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                const response = await fetch(appsScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteSugarRecord', userId: liffUserId, recordId: recordIdToDelete })
                });

                if (!response.ok) throw new Error('Failed to delete record from server.');

                const result = await response.json();
                
                if (result.status === 'success') {
                    displayMessage('success', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                    await fetchSugarRecords(liffUserId); // Refresh list
                } else {
                    displayMessage('error', `‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö'}`);
                }

            } catch (error) {
                console.error('Error deleting record:', error);
                displayMessage('error', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`);
            } finally {
                recordIdToDelete = null;
            }
        }

        function cancelDelete() {
            document.getElementById('confirmationModal').classList.remove('active');
            recordIdToDelete = null;
        }


        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;

            // Form submission
            document.getElementById('sugarRecordForm').addEventListener('submit', handleSaveSugarRecord);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

            // Modal listeners
            document.getElementById('modalConfirmBtn').addEventListener('click', confirmDelete);
            document.getElementById('modalCancelBtn').addEventListener('click', cancelDelete);
            document.getElementById('confirmationModal').addEventListener('click', (e) => {
                if (e.target.id === 'confirmationModal') cancelDelete();
            });

            // Navigation tab listeners (Same as before)
            document.getElementById('profileTab').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `${window.location.origin}/profile.html`;
            });
            document.getElementById('foodRecordsTab').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `${window.location.origin}/food_records.html`;
            });
            // sugarRecordsTab ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß
        });
    </script>
</body>
</html>