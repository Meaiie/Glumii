<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <span>‚ù§Ô∏è ‡πÅ‡∏≠‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</span>
            <div class="user-info">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="liffDisplayName">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà</span> <span>üë©‚Äçü¶∞</span>
            </div>
        </div>
        
        <div class="nav-tabs">
            <a href="#" class="nav-tab" id="profileTab">
                <i class="fas fa-user-alt"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </a>
            <a href="#" class="nav-tab" id="foodRecordsTab">
                <i class="fas fa-utensils"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </a>
            <a href="#" class="nav-tab active" id="sugarRecordsTab">
                <i class="fas fa-tint"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
            </a>
        </div>

        <div class="record-container">
            <div id="liffStatus" class="liff-status liff-disconnected">
                üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
            </div>

            <div class="record-section">
                <div class="section-header">
                    <h3 class="section-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</h3>
                </div>
                
                <form id="sugarRecordForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="recordDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                            <input type="date" id="recordDate" name="record_date" required>
                        </div>
                        <div class="form-group">
                            <label for="recordTime">‡πÄ‡∏ß‡∏•‡∏≤:</label>
                            <input type="time" id="recordTime" name="record_time" required>
                        </div>
                        <div class="form-group">
                            <label for="pbsValue">‡∏Ñ‡πà‡∏≤ PBS (Post-Breakfast Sugar):</label>
                            <input type="number" id="pbsValue" name="pbs_value" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="sugarFlag">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                            <select id="sugarFlag" name="sugar_flag" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="saveSugarRecordBtn" class="save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</button>
                    </div>
                </form>

                <div class="loading" id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                <div class="success-message" id="successMessage">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</div>
                <div class="error-message" id="errorMessage">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>

            <div class="record-list-section">
                <div class="section-header">
                    <h3 class="section-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</h3>
                </div>
                <div class="record-list" id="sugarRecordsList">
                    <p class="no-records" id="noRecordsMessage">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        let isLiffReady = false;
        let liffUserId = null;
        let userDisplayName = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà'; // Default display name

        async function initializeLiff() {
            try {
                await liff.init({ liffId: "2007493917-XdpdZalP" }); // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    isLiffReady = true;
                    document.getElementById('liffStatus').className = 'liff-status liff-connected';
                    document.getElementById('liffStatus').innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    
                    const profile = await liff.getProfile();
                    liffUserId = profile.userId;
                    userDisplayName = profile.displayName || '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà';
                    document.getElementById('liffDisplayName').innerText = userDisplayName;

                    await fetchSugarRecords(liffUserId);
                }
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                document.getElementById('liffStatus').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏î‡πâ';
                document.getElementById('liffStatus').className = 'liff-status liff-disconnected';
            }
        }

        async function fetchSugarRecords(userId) {
            console.log('Fetching sugar records for userId:', userId);
            document.getElementById('sugarRecordsList').innerHTML = '<p class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•...</p>';

            try {
                const url = '/.netlify/functions/apps-script-proxy'; 
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'getSugarRecords', userId: userId })
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Sugar records data from Netlify Function:', result);

                const sugarRecordsListDiv = document.getElementById('sugarRecordsList');
                sugarRecordsListDiv.innerHTML = ''; // Clear previous records

                if (result.status === 'success' && result.records && result.records.length > 0) {
                    result.records.forEach(record => {
                        const recordItem = document.createElement('div');
                        recordItem.classList.add('record-item');
                        recordItem.innerHTML = `
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatDate(record.datetime)} <strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${formatTime(record.datetime)}<br>
                            <strong>‡∏Ñ‡πà‡∏≤ PBS:</strong> ${record.pbs}<br>
                            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="sugar-flag-${record.sugarFlag === '‡∏õ‡∏Å‡∏ï‡∏¥' ? 'normal' : 'abnormal'}">${record.sugarFlag}</span>
                        `;
                        sugarRecordsListDiv.appendChild(recordItem);
                    });
                    document.getElementById('noRecordsMessage').style.display = 'none';
                } else {
                    document.getElementById('noRecordsMessage').style.display = 'block';
                }

            } catch (error) {
                console.error('Error fetching sugar records:', error);
                document.getElementById('sugarRecordsList').innerHTML = '<p class="error-message">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏î‡πâ</p>';
                document.getElementById('noRecordsMessage').style.display = 'none';
            }
        }

        async function handleSaveSugarRecord(event) {
            event.preventDefault();

            if (!isLiffReady || !liffUserId) {
                console.warn('LIFF not ready or userId not available for saving sugar record.');
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            const form = document.getElementById('sugarRecordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                document.getElementById('errorMessage').innerHTML = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            const recordDate = document.getElementById('recordDate').value;
            const recordTime = document.getElementById('recordTime').value;
            const pbsValue = document.getElementById('pbsValue').value;
            const sugarFlag = document.getElementById('sugarFlag').value;

            // Combine date and time for the datetime column
            const dateTimeCombined = `${recordDate}T${recordTime}:00`; // YYYY-MM-DDTHH:MM:SS

            const data = {
                action: 'addSugarRecord', // Action for Google Apps Script
                userId: liffUserId,
                datetime: dateTimeCombined,
                pbs: pbsValue,
                sugarFlag: sugarFlag
            };

            console.log('Data to be sent:', data);

            try {
                const url = '/.netlify/functions/apps-script-proxy'; 
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorDetails}`);
                }

                const result = await response.json();
                console.log('Save sugar record result:', result);

                document.getElementById('loading').style.display = 'none';

                if (result.status === 'success') {
                    document.getElementById('successMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('successMessage').style.display = 'none', 3000);
                    form.reset(); // Clear form after successful submission
                    await fetchSugarRecords(liffUserId); // Refresh records list
                } else {
                    document.getElementById('errorMessage').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'}`;
                    document.getElementById('errorMessage').style.display = 'block';
                    setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
                }

            } catch (error) {
                console.error('Error saving sugar record:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
            }
        }

        // Helper function to format date
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Helper function to format time
        function formatTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeLiff();

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;

            document.getElementById('sugarRecordForm').addEventListener('submit', handleSaveSugarRecord);

            // Navigation tab listeners
            document.getElementById('profileTab').addEventListener('click', (e) => {
                e.preventDefault();
                if (liff.isLoggedIn()) {
                    liff.openWindow({ url: `${window.location.origin}/profile.html`, external: false });
                } else {
                    console.warn('LIFF not logged in, cannot open profile page.');
                }
            });
            document.getElementById('foodRecordsTab').addEventListener('click', (e) => {
                e.preventDefault();
                if (liff.isLoggedIn()) {
                    liff.openWindow({ url: `${window.location.origin}/food_records.html`, external: false });
                } else {
                    console.warn('LIFF not logged in, cannot open food records page.');
                }
            });
            document.getElementById('sugarRecordsTab').addEventListener('click', (e) => {
                e.preventDefault();
                if (liff.isLoggedIn()) {
                    liff.openWindow({ url: `${window.location.origin}/sugar_records.html`, external: false });
                } else {
                    console.warn('LIFF not logged in, cannot open sugar records page.');
                }
            });
        });
    </script>
</body>
</html>